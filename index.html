<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestion des Autorisations de Sortie, Avances sur Salaire et Congés</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#e6f0ff',
              100: '#cce0ff',
              200: '#99c2ff',
              300: '#66a3ff',
              400: '#3385ff',
              500: '#0066ff',
              600: '#0052cc',
              700: '#003d99',
              800: '#002966',
              900: '#001433',
            }
          }
        }
      }
    }

    // Gestion du mode sombre
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      document.documentElement.classList.add('dark');
    }
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
      document.documentElement.classList.toggle('dark', event.matches);
    });
  </script>
  <style>
    /* Styles CSS inchangés */
    /* ... (le code CSS reste identique à celui fourni) ... */
  </style>
</head>
<body class="min-h-screen bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100">
  <!-- HTML structure inchangée -->
  <!-- ... (le code HTML reste identique à celui fourni) ... -->

  <script>
    // Structure des données de l'application
    const appData = {
      users: [],
      requests: [],
      leaveBalances: {},
      currentUser: null,
      lastSync: null
    };

    const API_URL = "https://script.google.com/macros/s/AKfycbx1da0SsSP_7hGxL2AQIbn1_DezdE_tHYU9ac_XbnZB8h4yzoiJo94uS12ptifcEzTeLg/exec";
    const API_KEY = "monsecret123";

    // Fonctions utilitaires
    function showLoading(message, details) {
      const overlay = document.getElementById('loading-overlay');
      document.getElementById('loading-message').textContent = message || "Chargement...";
      document.getElementById('loading-details').textContent = details || "Veuillez patienter...";
      overlay.classList.remove('hidden');
    }

    function hideLoading() {
      document.getElementById('loading-overlay').classList.add('hidden');
    }

    function updateSyncStatus(status, message) {
      const badge = document.getElementById('sync-status');
      const text = document.getElementById('sync-text');
      badge.className = "sync-badge";
      switch(status) {
        case 'online':
          badge.classList.add('online');
          badge.querySelector('i').className = 'fas fa-cloud-upload-alt';
          text.textContent = message || "Synchronisé";
          break;
        case 'offline':
          badge.classList.add('offline');
          badge.querySelector('i').className = 'fas fa-cloud-slash';
          text.textContent = message || "Hors ligne";
          break;
        case 'syncing':
          badge.classList.add('syncing');
          badge.querySelector('i').className = 'fas fa-sync-alt spin';
          text.textContent = message || "Synchronisation...";
          break;
      }
    }

    async function hashPassword(password) {
      const encoder = new TextEncoder();
      const data = encoder.encode(password);
      const hash = await crypto.subtle.digest('SHA-256', data);
      return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // Gestion du stockage local
    function saveToLocalStorage() {
      try {
        localStorage.setItem('users', JSON.stringify(appData.users));
        localStorage.setItem('requests', JSON.stringify(appData.requests));
        localStorage.setItem('leaveBalances', JSON.stringify(appData.leaveBalances));
        localStorage.setItem('lastSync', appData.lastSync);
      } catch (error) {
        console.error("Erreur lors de la sauvegarde locale:", error);
        showNotification("Erreur lors de la sauvegarde locale.", "error");
      }
    }

    async function loadFromLocalStorage() {
      try {
        const users = localStorage.getItem('users');
        if (users) appData.users = JSON.parse(users);
        const requests = localStorage.getItem('requests');
        if (requests) appData.requests = JSON.parse(requests);
        const leaveBalances = localStorage.getItem('leaveBalances');
        if (leaveBalances) appData.leaveBalances = JSON.parse(leaveBalances);
        const lastSync = localStorage.getItem('lastSync');
        if (lastSync) appData.lastSync = lastSync;
        if (appData.users.length === 0) await createDefaultData();
        return true;
      } catch (error) {
        console.error("Erreur lors du chargement local:", error);
        return false;
      }
    }

    async function createDefaultData() {
      const defaultUsers = [
        { id: 76, name: "ALILI HOUSSEM", email: "ALILIHOUSSEM@EASYWAYELECTO.COM", role: "Responsable", password: "1234" },
        { id: 1, name: "John Doe", email: "john.doe@example.com", role: "Employé", password: "1234" }
      ];
      appData.users = await Promise.all(defaultUsers.map(async u => ({
        ...u,
        password: await hashPassword(u.password)
      })));
      appData.requests = [];
      appData.leaveBalances = {};
      for (const user of appData.users) {
        if (user.role === "Employé") initializeLeaveBalances(user.id);
      }
      saveToLocalStorage();
    }

    // Gestion de la synchronisation avec le cloud
    async function syncWithCloud(manual = false) {
      try {
        if (!navigator.onLine) {
          updateSyncStatus('offline', 'Pas de connexion Internet');
          showNotification("Pas de connexion Internet. Les données seront synchronisées lorsque la connexion sera rétablie.", "error");
          return;
        }

        showLoading("Synchronisation", "Mise à jour des données avec le cloud...");
        updateSyncStatus('syncing', "Synchronisation...");

        // Charger d'abord les données du cloud
        await loadFromCloud();

        // Puis synchroniser les demandes non synchronisées
        const unsyncedRequests = appData.requests.filter(req => !req.synced);
        for (const req of unsyncedRequests) {
          await addToSheet("Demandes", [
            req.id, req.type, req.date, req.details, req.status,
            req.employeeId, req.managerId, req.createdAt, req.comment
          ]);
          req.synced = true;
        }

        appData.lastSync = new Date().toISOString();
        saveToLocalStorage();

        hideLoading();
        updateSyncStatus('online', 'Synchronisé');
        if (manual) showNotification("Synchronisation effectuée avec succès.", "success");

        // Mettre à jour l'affichage
        if (appData.currentUser) {
          if (appData.currentUser.role === "Employé") {
            updateEmployeeRequestsTable();
            updateLeaveBalanceDisplay();
          } else if (appData.currentUser.role === "Responsable") {
            updateManagerRequestsTables();
            updateUsersTable();
          }
        }
      } catch (error) {
        console.error("Erreur lors de la synchronisation:", error);
        hideLoading();
        updateSyncStatus('offline', 'Échec de synchronisation');
        showNotification("Échec de la synchronisation avec le cloud.", "error");
      }
    }

    async function fetchFromCloud() {
      await Promise.all([
        fetchFromSheet("Utilisateurs").then(data => {
          if (data) {
            appData.users = data.slice(1).map(row => ({
              id: row[0], name: row[1], email: row[2], role: row[3], password: row[4]
            }));
          }
        }),
        fetchFromSheet("Demandes").then(data => {
          if (data) {
            appData.requests = data.slice(1).map(row => ({
              id: row[0], type: row[1], date: row[2], details: row[3], status: row[4],
              employeeId: row[5], managerId: row[6], createdAt: row[7], comment: row[8],
              synced: true
            }));
          }
        }),
        fetchFromSheet("SoldesCongés").then(data => {
          if (data) {
            appData.leaveBalances = {};
            data.slice(1).forEach(row => {
              appData.leaveBalances[row[0]] = {
                annual: row[1], exceptional: row[2], recovery: row[3]
              };
            });
          }
        })
      ]);
    }

    async function fetchFromSheet(sheetName) {
      try {
        const response = await fetch(`${API_URL}?sheet=${sheetName}&key=${API_KEY}`);
        if (!response.ok) throw new Error("Erreur réseau ou clé invalide");
        return await response.json();
      } catch (error) {
        console.error(`Erreur lors de la récupération de ${sheetName}:`, error);
        throw error;
      }
    }

    async function addToSheet(sheetName, data) {
      try {
        const response = await fetch(`${API_URL}?sheet=${sheetName}&key=${API_KEY}`, {
          method: "POST",
          body: JSON.stringify(data),
        });
        if (!response.ok) throw new Error("Erreur réseau ou clé invalide");
      } catch (error) {
        console.error(`Erreur lors de l'ajout à ${sheetName}:`, error);
        throw error;
      }
    }

    // Le reste du code JavaScript reste identique jusqu'à initApp
    // ...

    async function initApp() {
      try {
        showLoading("Initialisation de l'application", "Chargement des données...");
        
        // Charger les données locales
        await loadFromLocalStorage();
        
        // Tenter une synchronisation initiale si connecté
        if (navigator.onLine) {
          await syncWithCloud();
        } else {
          updateSyncStatus('offline', 'Pas de connexion Internet');
          showNotification("Application démarrée en mode hors ligne.", "info");
        }

        // Configurer les gestionnaires d'événements
        setupLoginForm();
        setupLeaveForm();
        setupLeaveRequestForm();
        setupAdvanceRequestForm();
        setupExcelImport();
        setupLeaveBalanceImport();
        setupAddUserBtn();
        setupResetDataBtn();
        setupExportDataBtn();
        setupSyncDataBtn();

        // Initialiser les champs de date
        initDateFields();

        // Afficher la vue de connexion
        showView('login-view');

        // Configurer la synchronisation périodique (toutes les 5 minutes)
        setInterval(() => syncWithCloud(), 300000);

        // Écouter les changements de statut de connexion
        window.addEventListener('online', () => syncWithCloud());
        window.addEventListener('offline', () => updateSyncStatus('offline', 'Pas de connexion'));

        hideLoading();
        console.log("Application initialisée avec succès");
      } catch (error) {
        console.error("Erreur lors de l'initialisation:", error);
        hideLoading();
        updateSyncStatus('offline', 'Erreur d’initialisation');
        showNotification("Erreur lors de l'initialisation. Mode dégradé activé.", "error");

        // Configurer en mode dégradé
        setupLoginForm();
        setupLeaveForm();
        setupLeaveRequestForm();
        setupAdvanceRequestForm();
        setupExcelImport();
        setupLeaveBalanceImport();
        setupAddUserBtn();
        setupResetDataBtn();
        setupExportDataBtn();
        initDateFields();
        showView('login-view');
      }
    }

    // Démarrage de l'application
    document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>
