<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Autorisations de Sortie, Avances sur Salaire et Congés</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { primary: { 500: '#0066ff', 600: '#0052cc' } } } }
        };
        if (window.matchMedia('(prefers-color-scheme: dark)').matches) document.documentElement.classList.add('dark');
    </script>
    <style>
        body { font-family: 'Roboto', sans-serif; }
        .notification { animation: fadeIn 0.5s, fadeOut 0.5s 2.5s forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeOut { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-20px); } }
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; }
        .status-pending { background: rgba(234, 179, 8, 0.1); color: #eab308; }
        .status-approved { background: rgba(34, 197, 94, 0.1); color: #22c55e; }
        .status-rejected { background: rgba(239, 68, 68, 0.1); color: #ef4444; }
    </style>
</head>
<body class="min-h-screen bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100">
    <div id="notification-container" class="fixed top-4 right-4 z-50"></div>

    <header class="bg-white dark:bg-gray-800 shadow">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between">
            <h1 class="text-xl font-bold">Gestion des Autorisations & Congés</h1>
            <div id="user-info">
                <p class="user-name">Non connecté</p>
                <p class="user-role text-gray-500"></p>
                <button id="logout-button" class="hidden">Déconnexion</button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8">
        <div id="login-view">
            <div class="max-w-md mx-auto bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                <h2 class="text-2xl font-bold text-center mb-6">Connexion</h2>
                <div class="space-y-4">
                    <div>
                        <label for="email" class="block text-sm font-medium">Email</label>
                        <input type="email" id="email" class="mt-1 w-full p-2 border rounded dark:bg-gray-700" placeholder="Email">
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium">Mot de passe</label>
                        <input type="password" id="password" class="mt-1 w-full p-2 border rounded dark:bg-gray-700" placeholder="••••••••">
                    </div>
                    <button id="btn-login-email" class="w-full p-2 bg-primary-500 text-white rounded hover:bg-primary-600">Se connecter</button>
                </div>
            </div>
        </div>

        <div id="employee-view" class="hidden space-y-8">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                <h2 class="text-lg font-semibold mb-6">Solde des congés</h2>
                <div id="leave-balance" class="grid grid-cols-3 gap-4"></div>
            </div>
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                <h2 class="text-lg font-semibold mb-6">Nouvelle demande</h2>
                <form id="leave-form" class="space-y-4">
                    <select id="leave-type" class="w-full p-2 border rounded dark:bg-gray-700" required>
                        <option value="" disabled selected>Type de congé</option>
                        <option value="Annuel">Annuel</option>
                        <option value="Exceptionnel">Exceptionnel</option>
                        <option value="Récupération">Récupération</option>
                    </select>
                    <input type="date" id="leave-start-date" class="w-full p-2 border rounded dark:bg-gray-700" required>
                    <input type="date" id="leave-end-date" class="w-full p-2 border rounded dark:bg-gray-700" required>
                    <input type="number" id="leave-days" class="w-full p-2 border rounded bg-gray-100" readonly>
                    <button type="submit" class="p-2 bg-primary-500 text-white rounded hover:bg-primary-600">Soumettre</button>
                </form>
            </div>
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                <h2 class="text-lg font-semibold mb-6">Historique</h2>
                <table id="employee-requests-table" classholy="w-full">
                    <thead class="bg-gray-50 dark:bg-gray-700">
                        <tr><th>Type</th><th>Date</th><th>Détails</th><th>Statut</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="manager-view" class="hidden space-y-8">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                <h2 class="text-lg font-semibold mb-6">Demandes en attente</h2>
                <table id="pending-requests-table" class="w-full">
                    <thead class="bg-gray-50 dark:bg-gray-700">
                        <tr><th>Employé</th><th>Type</th><th>Date</th><th>Détails</th><th>Actions</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                <h2 class="text-lg font-semibold mb-6">Gestion des utilisateurs</h2>
                <button id="add-user-btn" class="p-2 bg-primary-500 text-white rounded">Ajouter utilisateur</button>
                <table id="users-table" class="w-full mt-4">
                    <thead class="bg-gray-50 dark:bg-gray-700">
                        <tr><th>Nom</th><th>Email</th><th>Rôle</th><th>Actions</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                <h2 class="text-lg font-semibold mb-6">Exportation</h2>
                <button id="export-data-btn" class="p-2 bg-primary-500 text-white rounded">Exporter</button>
            </div>
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                <h2 class="text-lg font-semibold mb-6">Réinitialisation</h2>
                <button id="reset-data-btn" class="p-2 bg-red-500 text-white rounded">Réinitialiser</button>
            </div>
        </div>
    </main>

    <script>
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hash = await crypto.subtle.digest('SHA-256', data);
            return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        const appData = { users: [], requests: [], leaveBalances: {}, currentUser: null };

        async function loadFromLocalStorage() {
            const users = localStorage.getItem('users');
            if (!users) {
                const defaultUsers = [
                    { id: 76, name: "ALILI HOUSSEM", email: "ALILIHOUSSEM@EASYWAYELECTO.COM", role: "Responsable", password: "1234" },
                    { id: 1, name: "John Doe", email: "john.doe@example.com", role: "Employé", password: "1234" }
                ];
                appData.users = await Promise.all(defaultUsers.map(async u => ({ ...u, password: await hashPassword(u.password) })));
            } else {
                appData.users = JSON.parse(users);
            }
            appData.requests = JSON.parse(localStorage.getItem('requests')) || [];
            appData.leaveBalances = JSON.parse(localStorage.getItem('leaveBalances')) || {};
        }

        function saveToLocalStorage() {
            localStorage.setItem('users', JSON.stringify(appData.users));
            localStorage.setItem('requests', JSON.stringify(appData.requests));
            localStorage.setItem('leaveBalances', JSON.stringify(appData.leaveBalances));
        }

        function showNotification(message, type = 'info') {
            const container = document.getElementById('notification-container');
            const div = document.createElement('div');
            div.className = `notification p-3 rounded ${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
            div.textContent = message;
            container.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }

        function showView(viewId) {
            document.querySelectorAll('main > div').forEach(div => div.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
            if (viewId === 'employee-view') updateEmployeeView();
            if (viewId === 'manager-view') updateManagerView();
        }

        function login(user) {
            appData.currentUser = user;
            document.querySelector('.user-name').textContent = user.name;
            document.querySelector('.user-role').textContent = user.role;
            document.getElementById('logout-button').classList.remove('hidden');
            showView(user.role === 'Employé' ? 'employee-view' : 'manager-view');
        }

        function logout() {
            appData.currentUser = null;
            document.querySelector('.user-name').textContent = "Non connecté";
            document.querySelector('.user-role').textContent = "";
            document.getElementById('logout-button').classList.add('hidden');
            showView('login-view');
        }

        function updateEmployeeView() {
            const userId = appData.currentUser.id;
            if (!appData.leaveBalances[userId]) appData.leaveBalances[userId] = { annual: 20, exceptional: 5, recovery: 10 };
            saveToLocalStorage();
            document.getElementById('leave-balance').innerHTML = `
                <div class="p-4 bg-gray-100 rounded">Annuel: ${appData.leaveBalances[userId].annual} jours</div>
                <div class="p-4 bg-gray-100 rounded">Exceptionnel: ${appData.leaveBalances[userId].exceptional} jours</div>
                <div class="p-4 bg-gray-100 rounded">Récupération: ${appData.leaveBalances[userId].recovery} jours</div>
            `;
            const tbody = document.querySelector('#employee-requests-table tbody');
            tbody.innerHTML = appData.requests.filter(r => r.employeeId === userId).map(r => `
                <tr>
                    <td class="p-4">${r.type}</td>
                    <td class="p-4">${r.date}</td>
                    <td class="p-4">${r.details}</td>
                    <td class="p-4"><span class="status-badge ${r.status === 'En attente' ? 'status-pending' : r.status === 'Approuvée' ? 'status-approved' : 'status-rejected'}">${r.status}</span></td>
                </tr>
            `).join('');
        }

        function updateManagerView() {
            const pendingTbody = document.querySelector('#pending-requests-table tbody');
            pendingTbody.innerHTML = appData.requests.filter(r => r.status === 'En attente').map(r => `
                <tr>
                    <td class="p-4">${appData.users.find(u => u.id === r.employeeId)?.name || 'Inconnu'}</td>
                    <td class="p-4">${r.type}</td>
                    <td class="p-4">${r.date}</td>
                    <td class="p-4">${r.details}</td>
                    <td class="p-4">
                        <button onclick="approveRequest(${r.id})" class="p-2 bg-green-500 text-white rounded">Approuver</button>
                        <button onclick="rejectRequest(${r.id})" class="p-2 bg-red-500 text-white rounded">Refuser</button>
                    </td>
                </tr>
            `).join('');
            const usersTbody = document.querySelector('#users-table tbody');
            usersTbody.innerHTML = appData.users.map(u => `
                <tr>
                    <td class="p-4">${u.name}</td>
                    <td class="p-4">${u.email}</td>
                    <td class="p-4">${u.role}</td>
                    <td class="p-4">
                        <button onclick="deleteUser(${u.id})" class="p-2 bg-red-500 text-white rounded">Supprimer</button>
                    </td>
                </tr>
            `).join('');
        }

        async function init() {
            await loadFromLocalStorage();

            document.getElementById('btn-login-email').addEventListener('click', async () => {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const hashedPassword = await hashPassword(password);
                const user = appData.users.find(u => u.email.toLowerCase() === email.toLowerCase() && u.password === hashedPassword);
                if (user) login(user);
                else showNotification("Identifiants incorrects", "error");
            });

            document.getElementById('logout-button').addEventListener('click', logout);

            document.getElementById('leave-form').addEventListener('submit', e => {
                e.preventDefault();
                const type = document.getElementById('leave-type').value;
                const start = document.getElementById('leave-start-date').value;
                const end = document.getElementById('leave-end-date').value;
                const days = Math.ceil((new Date(end) - new Date(start)) / (1000 * 60 * 60 * 24)) + 1;
                const balance = appData.leaveBalances[appData.currentUser.id][type.toLowerCase()];
                if (days > balance) return showNotification("Solde insuffisant", "error");
                appData.requests.push({
                    id: appData.requests.length + 1,
                    type: `Congé ${type}`,
                    date: start,
                    details: `${days} jours`,
                    status: "En attente",
                    employeeId: appData.currentUser.id
                });
                saveToLocalStorage();
                updateEmployeeView();
                showNotification("Demande soumise", "success");
            });

            document.getElementById('add-user-btn').addEventListener('click', async () => {
                const name = prompt("Nom :");
                const email = prompt("Email :");
                const role = prompt("Rôle (Employé/Responsable) :");
                const password = prompt("Mot de passe :");
                const hashedPassword = await hashPassword(password);
                appData.users.push({ id: appData.users.length + 1, name, email, role, password: hashedPassword });
                saveToLocalStorage();
                updateManagerView();
            });

            document.getElementById('export-data-btn').addEventListener('click', () => {
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(appData.users), "Utilisateurs");
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(Object.entries(appData.leaveBalances).map(([id, b]) => ({ id, ...b }))), "Soldes");
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(appData.requests), "Demandes");
                XLSX.writeFile(wb, "donnees.xlsx");
            });

            document.getElementById('reset-data-btn').addEventListener('click', async () => {
                localStorage.clear();
                await loadFromLocalStorage();
                updateManagerView();
                showNotification("Données réinitialisées", "success");
            });

            showView('login-view');
        }

        window.approveRequest = id => {
            const req = appData.requests.find(r => r.id === id);
            req.status = "Approuvée";
            const type = req.type.split(' ')[1].toLowerCase();
            appData.leaveBalances[req.employeeId][type] -= parseInt(req.details);
            saveToLocalStorage();
            updateManagerView();
        };

        window.rejectRequest = id => {
            const req = appData.requests.find(r => r.id === id);
            req.status = "Refusée";
            saveToLocalStorage();
            updateManagerView();
        };

        window.deleteUser = id => {
            appData.users = appData.users.filter(u => u.id !== id);
            saveToLocalStorage();
            updateManagerView();
        };

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
