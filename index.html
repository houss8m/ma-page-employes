<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestion des Autorisations de Sortie, Avances sur Salaire et Congés</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#e6f0ff',
              100: '#cce0ff',
              200: '#99c2ff',
              300: '#66a3ff',
              400: '#3385ff',
              500: '#0066ff',
              600: '#0052cc',
              700: '#003d99',
              800: '#002966',
              900: '#001433',
            }
          }
        }
      }
    }
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      document.documentElement.classList.add('dark');
    }
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
      document.documentElement.classList.toggle('dark', event.matches);
    });
  </script>
  <style>
    /* Styles personnalisés si nécessaire */
    .status-badge { padding: 0.25rem 0.5rem; border-radius: 9999px; font-size: 0.875rem; }
    .status-pending { background-color: #fefcbf; color: #975a16; }
    .status-approved { background-color: #c6f6d5; color: #276749; }
    .status-rejected { background-color: #fed7d7; color: #9b2c2c; }
    .spin { animation: spin 1s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    .sync-badge { padding: 0.25rem; border-radius: 9999px; }
    .sync-badge.online { background-color: #c6f6d5; color: #276749; }
    .sync-badge.offline { background-color: #fed7d7; color: #9b2c2c; }
    .sync-badge.syncing { background-color: #fefcbf; color: #975a16; }
  </style>
</head>
<body class="min-h-screen bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100">
  <!-- Structure HTML existante (non modifiée ici pour brièveté) -->
  <div id="loading-overlay" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
      <p id="loading-message" class="text-lg font-medium text-gray-900 dark:text-white">Chargement...</p>
      <p id="loading-details" class="text-sm text-gray-600 dark:text-gray-300 mt-2">Veuillez patienter...</p>
    </div>
  </div>
  <div id="notification-container" class="fixed bottom-4 right-4 z-50"></div>

  <script>
    // Structure des données de l'application
    const appData = {
      users: [],
      requests: [],
      leaveBalances: {},
      currentUser: null,
      lastSync: null
    };

    // URL de l'API Google Sheets
    const API_URL = "https://script.google.com/macros/s/AKfycbx1da0SsSP_7hGxL2AQIbn1_DezdE_tHYU9ac_XbnZB8h4yzoiJo94uS12ptifcEzTeLg/exec";
    const API_KEY = "monsecret123"; // Remplacez par votre clé définie dans Apps Script

    // Afficher l'overlay de chargement
    function showLoading(message, details) {
      const overlay = document.getElementById('loading-overlay');
      document.getElementById('loading-message').textContent = message || "Chargement...";
      document.getElementById('loading-details').textContent = details || "Veuillez patienter...";
      overlay.classList.remove('hidden');
    }

    // Masquer l'overlay de chargement
    function hideLoading() {
      document.getElementById('loading-overlay').classList.add('hidden');
    }

    // Mettre à jour le statut de synchronisation
    function updateSyncStatus(status, message) {
      const badge = document.createElement('span'); // Remplacez par un élément existant si nécessaire
      const text = document.createElement('span');
      badge.className = "sync-badge";
      switch(status) {
        case 'online':
          badge.classList.add('online');
          badge.innerHTML = '<i class="fas fa-cloud-upload-alt"></i>';
          text.textContent = message || "Synchronisé";
          break;
        case 'offline':
          badge.classList.add('offline');
          badge.innerHTML = '<i class="fas fa-cloud-slash"></i>';
          text.textContent = message || "Hors ligne";
          break;
        case 'syncing':
          badge.classList.add('syncing');
          badge.innerHTML = '<i class="fas fa-sync-alt spin"></i>';
          text.textContent = message || "Synchronisation...";
          break;
      }
      // Ajoutez badge et text au DOM si nécessaire
    }

    // Hacher les mots de passe
    async function hashPassword(password) {
      const encoder = new TextEncoder();
      const data = encoder.encode(password);
      const hash = await crypto.subtle.digest('SHA-256', data);
      return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // Sauvegarder les données localement
    function saveToLocalStorage() {
      try {
        localStorage.setItem('users', JSON.stringify(appData.users));
        localStorage.setItem('requests', JSON.stringify(appData.requests));
        localStorage.setItem('leaveBalances', JSON.stringify(appData.leaveBalances));
        localStorage.setItem('lastSync', appData.lastSync);
      } catch (error) {
        console.error("Erreur lors de la sauvegarde locale:", error);
        showNotification("Erreur lors de la sauvegarde locale.", "error");
      }
    }

    // Charger les données depuis localStorage
    async function loadFromLocalStorage() {
      try {
        const users = localStorage.getItem('users');
        if (users) appData.users = JSON.parse(users);
        const requests = localStorage.getItem('requests');
        if (requests) appData.requests = JSON.parse(requests);
        const leaveBalances = localStorage.getItem('leaveBalances');
        if (leaveBalances) appData.leaveBalances = JSON.parse(leaveBalances);
        const lastSync = localStorage.getItem('lastSync');
        if (lastSync) appData.lastSync = lastSync;
        return true;
      } catch (error) {
        console.error("Erreur lors du chargement local:", error);
        return false;
      }
    }

    // Créer des données par défaut
    async function createDefaultData() {
      const defaultUsers = [
        { id: 76, name: "ALILI HOUSSEM", email: "ALILIHOUSSEM@EASYWAYELECTO.COM", role: "Responsable", password: "1234" },
        { id: 1, name: "John Doe", email: "john.doe@example.com", role: "Employé", password: "1234" }
      ];
      appData.users = await Promise.all(defaultUsers.map(async u => ({
        ...u,
        password: await hashPassword(u.password)
      })));
      appData.requests = [];
      appData.leaveBalances = {};
      for (const user of appData.users) {
        if (user.role === "Employé") {
          initializeLeaveBalances(user.id);
        }
      }
      saveToLocalStorage();
    }

    // Récupérer les données depuis Google Sheets
    async function fetchFromSheet(sheetName) {
      try {
        showLoading("Récupération des données", `Chargement de ${sheetName}...`);
        updateSyncStatus('syncing', "Récupération...");
        const response = await fetch(`${API_URL}?sheet=${sheetName}&key=${API_KEY}`);
        if (!response.ok) throw new Error("Erreur réseau ou clé invalide");
        const data = await response.json();
        hideLoading();
        updateSyncStatus('online', "Données récupérées");
        return data;
      } catch (error) {
        console.error(`Erreur lors de la récupération de ${sheetName}:`, error);
        hideLoading();
        updateSyncStatus('offline', "Échec de récupération");
        showNotification(`Impossible de récupérer ${sheetName}.`, "error");
        return null;
      }
    }

    // Ajouter des données à Google Sheets
    async function addToSheet(sheetName, data) {
      try {
        updateSyncStatus('syncing', "Ajout en cours...");
        const response = await fetch(`${API_URL}?sheet=${sheetName}&key=${API_KEY}`, {
          method: "POST",
          body: JSON.stringify(data),
        });
        if (!response.ok) throw new Error("Erreur réseau ou clé invalide");
        updateSyncStatus('online', "Synchronisé");
        showNotification("Donnée ajoutée avec succès.", "success");
      } catch (error) {
        console.error(`Erreur lors de l'ajout à ${sheetName}:`, error);
        updateSyncStatus('offline', "Échec d’ajout");
        showNotification("Échec de l’ajout.", "error");
      }
    }

    // Charger les données depuis Google Sheets au démarrage
    async function loadFromCloud() {
      const usersData = await fetchFromSheet("Utilisateurs");
      if (usersData) {
        appData.users = usersData.slice(1).map(row => ({
          id: row[0], name: row[1], email: row[2], role: row[3], password: row[4]
        }));
      }

      const requestsData = await fetchFromSheet("Demandes");
      if (requestsData) {
        appData.requests = requestsData.slice(1).map(row => ({
          id: row[0], type: row[1], date: row[2], details: row[3], status: row[4],
          employeeId: row[5], managerId: row[6], createdAt: row[7], comment: row[8]
        }));
      }

      const leaveBalancesData = await fetchFromSheet("SoldesCongés");
      if (leaveBalancesData) {
        appData.leaveBalances = {};
        leaveBalancesData.slice(1).forEach(row => {
          appData.leaveBalances[row[0]] = {
            annual: row[1], exceptional: row[2], recovery: row[3]
          };
        });
      }
    }

    // Synchroniser les données avec Google Sheets
    async function syncToCloud() {
      const unsyncedRequests = appData.requests.filter(req => !req.synced);
      for (const req of unsyncedRequests) {
        await addToSheet("Demandes", [
          req.id, req.type, req.date, req.details, req.status,
          req.employeeId, req.managerId, req.createdAt, req.comment
        ]);
        req.synced = true;
      }
      saveToLocalStorage();
    }

    // Initialiser les soldes de congés
    function initializeLeaveBalances(userId) {
      if (!appData.leaveBalances[userId]) {
        appData.leaveBalances[userId] = {
          annual: 20,
          exceptional: 5,
          recovery: 10
        };
        saveToLocalStorage();
      }
    }

    // Afficher une notification
    function showNotification(message, type = 'info') {
      const container = document.getElementById('notification-container');
      const notificationEl = document.createElement('div');
      notificationEl.className = `notification mb-2 p-3 rounded-lg shadow-lg max-w-md ${
        type === 'success' ? 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-100' : 
        type === 'error' ? 'bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-100' : 
        'bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-100'
      }`;
      const icon = type === 'success' ? '<i class="fas fa-check-circle mr-2"></i>' : 
        type === 'error' ? '<i class="fas fa-exclamation-circle mr-2"></i>' : 
        '<i class="fas fa-info-circle mr-2"></i>';
      notificationEl.innerHTML = `<div class="flex items-center">${icon}<span>${message}</span></div>`;
      container.appendChild(notificationEl);
      setTimeout(() => notificationEl.remove(), 3000);
    }

    // Initialisation de l'application
    async function initApp() {
      try {
        showLoading("Initialisation", "Chargement des données...");
        await loadFromLocalStorage();
        if (!appData.users.length) await createDefaultData();
        await loadFromCloud();
        hideLoading();
        showNotification("Application initialisée avec succès.", "success");
        setInterval(() => appData.currentUser && syncToCloud(), 300000); // Synchro toutes les 5 min
      } catch (error) {
        console.error("Erreur lors de l'initialisation:", error);
        hideLoading();
        showNotification("Erreur lors de l'initialisation.", "error");
      }
    }

    // Démarrer l'application
    document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>
