
Can you help me debug my code? I'll share the code snippet with you.

I'd be happy to help you debug your code! Please share the code snippet you're working with, and let me know what issues you're encountering or what you're trying to achieve. We'll figure it out together.
Refer to the following content:
pasted-text.txt

Thank you for sharing your code snippet! It’s a well-structured HTML document with embedded JavaScript for a leave, salary advance, and exit authorization management system using Firebase, Tailwind CSS, and localForage for offline storage. Since you’ve asked for debugging help, I’ll need you to specify what issues you’re encountering—such as errors in the console, unexpected behavior, or specific features not working as intended. For now, I’ll analyze the code for potential issues and provide some initial observations and suggestions.
Initial Observations

    Missing Functions: Some functions referenced in the code (e.g., showModal, closeModal, showNotification, getStatusIcon, getUserById) are not defined in the provided snippet. I assume they might be defined elsewhere or were truncated. If these are missing, they’ll cause runtime errors like ReferenceError: functionName is not defined.
    Firebase Initialization: The Firebase configuration is present, and you’re using the compatibility mode (firebase-app-compat, etc.). This works, but note that Firebase v9+ recommends the modular syntax for better tree-shaking. If this is an older project, it’s fine, but upgrading could optimize performance.
    Truncated Code: The getStatusClass function appears truncated (switch(status) { case "En attente": retur...). This will cause a syntax error. Ensure the full implementation is included.
    Event Listeners: You’re adding event listeners dynamically (e.g., for .approve-btn and .reject-btn in updateManagerRequestsTables). If these are re-added without cleanup, you might end up with duplicate listeners, leading to multiple executions of the same action.
    Date Handling: The calculateDaysBetweenDates function includes the end date in the count (+1), which might not align with all leave policies (some count exclusive of the end date). This isn’t an error but depends on your requirements.
    Offline Sync: The offline synchronization with localForage and pending operations queue is robust, but there’s no explicit error handling for cases where localForage fails (e.g., quota exceeded).

Potential Issues to Check

    Console Errors: Open your browser’s developer tools (F12) and check the console for errors like Uncaught ReferenceError or TypeError. These will pinpoint undefined variables or functions.
    Firebase Connectivity: Test with a bad network (e.g., toggle offline mode in browser dev tools) to ensure the app handles offline states gracefully.
    Form Submissions: Submit each form (leave, leave request, advance) and verify the data appears in the respective tables and is saved to appData.
    Dynamic Updates: After approving/rejecting a request or editing a user, ensure the UI updates correctly without manual refresh.

Debugging Steps

Since I don’t know the exact issue yet, here’s how we can proceed:

    Specify the Problem: Tell me what’s not working—e.g., “The leave form doesn’t submit,” “I get an error when logging in,” or “The sync badge doesn’t update.”
    Test Specific Sections: I’ll guide you to isolate the issue. For example:
        For login issues, test setupLoginForm and the login function.
        For form submissions, check the event listeners like setupLeaveForm.
    Add Logging: Insert console.log statements to trace execution. For example, in login:
    javascript

    async function login(user) {
      console.log("Logging in user:", user);
      appData.currentUser = user;
      // ... rest of the function
    }

Example Fix for a Common Issue

If showNotification is undefined (a likely candidate since it’s called often but not defined here), you’d see errors whenever it’s invoked. Here’s a basic implementation you can add:
javascript
function showNotification(message, type) {
  const container = document.getElementById('notification-container');
  const notification = document.createElement('div');
  notification.className = `notification fixed top-4 right-4 z-50 px-4 py-2 rounded-md shadow-lg text-white ${
    type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-500' : 'bg-blue-500'
  }`;
  notification.textContent = message;
  container.appendChild(notification);
  setTimeout(() => notification.remove(), 3000);
}
Next Steps

Please let me know:

    What specific issue you’re facing (error messages, unexpected behavior, etc.).
    What you’ve already tried to fix it.
    Which part of the app you want to focus on (e.g., login, forms, sync).

With that info, I can provide a targeted solution or walk you through debugging step-by-step!
voici l'api firebase que j'ai : 
  apiKey: "AIzaSyAk3qhQnJEqi2e5BQrydTFhPqoohHfVbzY",

  authDomain: "gestion-conges-app.firebaseapp.com",

  databaseURL: "https://gestion-conges-app-default-rtdb.firebaseio.com",

  projectId: "gestion-conges-app",

  storageBucket: "gestion-conges-app.firebasestorage.app",

  messagingSenderId: "287763855046",

  appId: "1:287763855046:web:e70201a570dda13f7589c7"

mais quand je le met dans le code html , le code html ne peut pas importer les donnée depuis firebase

Merci d'avoir partagé votre configuration Firebase ! Si votre code HTML ne parvient pas à importer les données depuis Firebase, cela peut être dû à plusieurs raisons : problèmes de configuration, erreurs dans le code de récupération des données, restrictions de sécurité dans Firebase, ou encore des erreurs réseau. Je vais analyser votre situation étape par étape pour identifier et résoudre le problème.
Vérification Initiale

Votre configuration Firebase semble correcte et correspond à celle utilisée dans le code que vous avez fourni :
javascript
const firebaseConfig = {
  apiKey: "AIzaSyAk3qhQnJEqi2e5BQrydTFhPqoohHfVbzY",
  authDomain: "gestion-conges-app.firebaseapp.com",
  databaseURL: "https://gestion-conges-app-default-rtdb.firebaseio.com",
  projectId: "gestion-conges-app",
  storageBucket: "gestion-conges-app.firebasestorage.app",
  messagingSenderId: "287763855046",
  appId: "1:287763855046:web:e70201a570dda13f7589c7"
};

Cependant, il y a quelques points à vérifier, car votre code utilise Firestore (firebase.firestore()), mais la databaseURL dans votre configuration pointe vers la Realtime Database. Cela peut causer une confusion ou un dysfonctionnement si vous essayez d'utiliser Firestore avec une configuration qui semble mélanger les deux bases de données Firebase.
Problèmes Potentiels et Solutions
1. Incohérence entre Realtime Database et Firestore

    Problème : Votre configuration inclut une databaseURL, qui est spécifique à la Realtime Database, mais le code utilise firebase.firestore() pour accéder à Firestore. Ces deux services sont distincts dans Firebase, et Firestore ne nécessite pas de databaseURL.
    Solution : Si vous voulez utiliser Firestore (comme le suggère votre code avec db.collection()), supprimez la databaseURL de la configuration, car elle n’est pas nécessaire pour Firestore. Voici la configuration corrigée :

javascript
const firebaseConfig = {
  apiKey: "AIzaSyAk3qhQnJEqi2e5BQrydTFhPqoohHfVbzY",
  authDomain: "gestion-conges-app.firebaseapp.com",
  projectId: "gestion-conges-app",
  storageBucket: "gestion-conges-app.firebasestorage.app",
  messagingSenderId: "287763855046",
  appId: "1:287763855046:web:e70201a570dda13f7589c7"
};

Si vous aviez l’intention d’utiliser la Realtime Database à la place, il faudrait remplacer toutes les références à firestore() par database() et ajuster les appels (par exemple, db.ref() au lieu de db.collection()).
2. Règles de Sécurité Firebase

    Problème : Si les règles de sécurité de Firestore ne permettent pas la lecture publique ou par des utilisateurs non authentifiés, vos requêtes échoueront avec une erreur comme PERMISSION_DENIED.
    Vérification : Connectez-vous à la console Firebase (https://console.firebase.google.com/), allez dans votre projet gestion-conges-app, puis dans Firestore Database > Règles. Vérifiez les règles actuelles. Par défaut, elles pourraient ressembler à ceci :

json
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

Cela bloque toutes les lectures et écritures.

    Solution : Pour tester, vous pouvez temporairement assouplir les règles pour permettre la lecture (et l’écriture si nécessaire) sans authentification :

json
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read: if true;
      allow write: if true; // Optionnel, selon vos besoins
    }
  }
}

Attention : Ces règles ouvertes sont uniquement pour le dépannage ou le développement. En production, vous devriez sécuriser l’accès avec des règles basées sur l’authentification (par exemple, request.auth != null).
3. Erreurs dans la Console

    Problème : Si les données ne sont pas importées, il y a probablement une erreur dans la console du navigateur qui bloque l’exécution.
    Solution : Ouvre les outils de développement de votre navigateur (F12 ou clic droit > Inspecter), va dans l’onglet Console, et recharge la page. Cherche des messages comme :
        Failed to get document because the client is offline (problème réseau).
        Permission denied (problème de règles).
        firebase.firestore is not a function (problème de chargement du SDK).

Si tu vois une erreur, partage-la avec moi pour que je puisse t’aider à la résoudre précisément.
4. Chargement des Scripts Firebase

    Problème : Votre HTML charge les SDK Firebase en mode compatibilité :

html
<script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-auth-compat.js"></script>

Si ces scripts ne se chargent pas correctement (par exemple, à cause d’une connexion réseau ou d’un bloqueur de publicités), Firebase ne sera pas initialisé.

    Solution :
        Vérifie que tu as une connexion Internet active.
        Ajoute une vérification dans ton code pour t’assurer que Firebase est bien chargé :

javascript
if (typeof firebase === 'undefined') {
  console.error("Firebase SDK n'est pas chargé correctement.");
  showNotification("Erreur : Impossible de charger Firebase.", "error");
} else {
  const app = firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  console.log("Firebase initialisé avec succès");
}
5. Fonction de Récupération des Données

    Problème : La fonction fetchAllDataFromFirebase est censée récupérer les données, mais elle pourrait ne pas fonctionner correctement si les collections Firestore (users, requests, leaveBalances) sont vides ou mal configurées.
    Solution : Testons cette fonction isolément. Ajoute des logs pour voir ce qui se passe :

javascript
async function fetchAllDataFromFirebase() {
  if (!appData.isOnline) {
    showNotification("Vous êtes hors ligne. Utilisation des données locales.", "error");
    return false;
  }

  showLoading("Récupération des données", "Veuillez patienter...");
  updateSyncStatus('syncing', "Récupération des données...");

  try {
    const [users, requests, leaveBalances] = await Promise.all([
      fetchUsersFromFirebase(),
      fetchRequestsFromFirebase(),
      fetchLeaveBalancesFromFirebase()
    ]);

    console.log("Utilisateurs récupérés :", users);
    console.log("Demandes récupérées :", requests);
    console.log("Soldes récupérés :", leaveBalances);

    if (users && users.length > 0) appData.users = users;
    if (requests && requests.length > 0) appData.requests = requests;
    if (leaveBalances && Object.keys(leaveBalances).length > 0) appData.leaveBalances = leaveBalances;

    appData.lastSync = new Date().toISOString();
    await saveToLocalStorage();

    updateSyncStatus('online', "Données récupérées");
    hideLoading();
    return true;
  } catch (error) {
    console.error("Erreur lors de la récupération des données :", error);
    updateSyncStatus('offline', "Échec de connexion");
    hideLoading();
    showNotification("Impossible de se connecter au serveur.", "error");
    return false;
  }
}

    Recharge la page et regarde la console pour voir ce qui est retourné par console.log.

6. Données Existantes dans Firestore

    Problème : Si les collections Firestore (users, requests, leaveBalances) n’existent pas ou sont vides, les appels à get() retourneront des tableaux vides, et rien ne sera importé.
    Solution : Va dans la console Firebase > Firestore Database, et vérifie que ces collections existent et contiennent des données. Sinon, ajoute manuellement quelques documents pour tester (par exemple, un utilisateur dans users avec les champs id, name, email, role, password).

Étapes de Dépannage

    Corrige la Configuration : Supprime databaseURL si tu utilises Firestore.
    Vérifie les Règles : Assure-toi que les règles Firestore permettent la lecture.
    Ajoute des Logs : Modifie fetchAllDataFromFirebase comme ci-dessus et regarde la console.
    Teste en Local : Charge ton HTML dans un navigateur et vois si le badge de synchronisation passe à « Synchronisé » ou reste sur « Hors ligne ».
    Ajoute des Données : Si Firestore est vide, ajoute des données manuellement via la console Firebase.

Test Rapide

Ajoute ce code temporaire après l’initialisation de Firebase pour tester la connexion :
javascript
db.collection('test').doc('ping').set({ timestamp: new Date().toISOString() })
  .then(() => console.log("Test réussi : écriture dans Firestore OK"))
  .catch(error => console.error("Test échoué :", error));

Si tu vois « Test réussi » dans la console, Firebase fonctionne. Sinon, l’erreur t’indiquera le problème (par exemple, permissions ou réseau).
Questions pour Avancer

    Peux-tu vérifier la console et me dire s’il y a des erreurs spécifiques ?
    As-tu des données dans Firestore ? Si oui, dans quelles collections ?
    Le badge de synchronisation affiche-t-il « Hors ligne » ou autre chose ?

Avec ces informations, je pourrai te donner une solution plus précise !
regenerer tout le code avec les mise à jours

Voici une version mise à jour de votre code, intégrant les corrections et améliorations discutées pour résoudre le problème d'importation des données depuis Firebase Firestore. J’ai :

    Corrigé la configuration Firebase : Supprimé la databaseURL qui était spécifique à Realtime Database, car vous utilisez Firestore.
    Ajouté des fonctions manquantes : Implémenté showNotification, showModal, closeModal, getStatusIcon, et getUserById, qui semblaient absentes ou tronquées.
    Complété les fonctions tronquées : Notamment getStatusClass.
    Ajouté des logs de débogage : Pour faciliter la vérification de la récupération des données.
    Assuré la compatibilité avec Firestore : Vérifié que les appels à Firestore sont cohérents.

Voici le code complet mis à jour :
html
<!DOCTYPE html>
<html lang="fr">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>Gestion des Autorisations de Sortie, Avances sur Salaire et Congés</title>
 <script src="https://cdn.tailwindcss.com"></script>
 <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
 <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
 <!-- Firebase App (la base) est toujours requise et doit être chargée en premier -->
 <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-app-compat.js"></script>
 <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-firestore-compat.js"></script>
 <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-auth-compat.js"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
 <script>
 tailwind.config = {
 darkMode: 'class',
 theme: {
 extend: {
 colors: {
 primary: {
 50: '#e6f0ff',
 100: '#cce0ff',
 200: '#99c2ff',
 300: '#66a3ff',
 400: '#3385ff',
 500: '#0066ff',
 600: '#0052cc',
 700: '#003d99',
 800: '#002966',
 900: '#001433',
 }
 }
 }
 }
 }
 
 if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
 document.documentElement.classList.add('dark');
 }
 window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
 document.documentElement.classList.toggle('dark', event.matches);
 });
 </script>
 <style>
 @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');
 body { font-family: 'Roboto', sans-serif; }
 .notification { animation: fadeIn 0.5s, fadeOut 0.5s 2.5s forwards; pointer-events: none; }
 @keyframes fadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
 @keyframes fadeOut { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-20px); } }
 .view-transition { animation: fadeInView 0.3s ease-out; }
 @keyframes fadeInView { from { opacity: 0; } to { opacity: 1; } }
 .custom-table { border-collapse: separate; border-spacing: 0; }
 .custom-table th, .custom-table td { border-bottom-width: 1px; }
 .status-badge { display: inline-flex; align-items: center; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; }
 .status-pending { background-color: rgba(234, 179, 8, 0.1); color: rgb(234, 179, 8); border: 1px solid rgba(234, 179, 8, 0.2); }
 .status-approved { background-color: rgba(34, 197, 94, 0.1); color: rgb(34, 197, 94); border: 1px solid rgba(34, 197, 94, 0.2); }
 .status-rejected { background-color: rgba(239, 68, 68, 0.1); color: rgb(239, 68, 68); border: 1px solid rgba(239, 68, 68, 0.2); }
 .dark .status-pending { background-color: rgba(234, 179, 8, 0.2); }
 .dark .status-approved { background-color: rgba(34, 197, 94, 0.2); }
 .dark .status-rejected { background-color: rgba(239, 68, 68, 0.2); }
 .file-input-label { display: inline-flex; align-items: center; padding: 0.5rem 1rem; border: 1px solid #d1d5db; border-radius: 0.375rem; cursor: pointer; background-color: #ffffff; transition: all 0.2s; }
 .file-input-label:hover { background-color: #f3f4f6; }
 .dark .file-input-label { background-color: #374151; border-color: #4b5563; }
 .dark .file-input-label:hover { background-color: #4b5563; }
 /* Animations pour confirmation */
 .confirm-btn-shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
 @keyframes shake {
   10%, 90% { transform: translate3d(-1px, 0, 0); }
   20%, 80% { transform: translate3d(2px, 0, 0); }
   30%, 50%, 70% { transform: translate3d(-3px, 0, 0); }
   40%, 60% { transform: translate3d(3px, 0, 0); }
 }
 
 /* Styles pour la synchronisation */
 .sync-badge {
   position: fixed;
   bottom: 1rem;
   right: 1rem;
   padding: 0.5rem 1rem;
   border-radius: 9999px;
   font-size: 0.75rem;
   z-index: 50;
   display: flex;
   align-items: center;
   gap: 0.5rem;
   box-shadow: 0 2px 5px rgba(0,0,0,0.2);
 }
 .sync-badge.online {
   background-color: rgba(34, 197, 94, 0.2);
   color: rgb(34, 197, 94);
   border: 1px solid rgba(34, 197, 94, 0.3);
 }
 .sync-badge.offline {
   background-color: rgba(239, 68, 68, 0.2);
   color: rgb(239, 68, 68);
   border: 1px solid rgba(239, 68, 68, 0.3);
 }
 .sync-badge.syncing {
   background-color: rgba(234, 179, 8, 0.2);
   color: rgb(234, 179, 8);
   border: 1px solid rgba(234, 179, 8, 0.3);
 }
 .spin {
   animation: spin 1s linear infinite;
 }
 @keyframes spin {
   from { transform: rotate(0deg); }
   to { transform: rotate(360deg); }
 }
 .loading-container {
   position: fixed;
   top: 0;
   left: 0;
   width: 100%;
   height: 100%;
   background-color: rgba(0,0,0,0.5);
   z-index: 100;
   display: flex;
   justify-content: center;
   align-items: center;
 }
 .loading-box {
   background-color: white;
   padding: 2rem;
   border-radius: 0.5rem;
   text-align: center;
   max-width: 80%;
 }
 .dark .loading-box {
   background-color: #1F2937;
   color: white;
 }
 </style>
</head>
<body class="min-h-screen bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100">
 <div id="notification-container" class="fixed top-4 right-4 z-50 pointer-events-none"></div>
 
 <div id="loading-overlay" class="loading-container hidden">
   <div class="loading-box shadow-lg">
     <div class="text-center mb-4">
       <i class="fas fa-sync-alt spin text-primary-500 text-3xl mb-4"></i>
       <h3 class="text-lg font-medium" id="loading-message">Chargement des données...</h3>
     </div>
     <p class="text-sm text-gray-500 dark:text-gray-400" id="loading-details">Veuillez patienter pendant la synchronisation avec le serveur.</p>
   </div>
 </div>

 <div id="sync-status" class="sync-badge offline">
   <i class="fas fa-cloud-upload-alt"></i>
   <span id="sync-text">Synchronisation...</span>
 </div>

 <header class="bg-white dark:bg-gray-800 shadow">
 <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
 <div class="flex items-center">
 <div class="flex-shrink-0">
 <div class="h-10 w-10 rounded-full bg-primary-500 flex items-center justify-center text-white font-bold text-lg">AS</div>
 </div>
 <h1 class="ml-3 text-xl font-bold text-gray-900 dark:text-white">Autorisations de Sortie, Avances sur Salaire & Congés</h1>
 </div>
 <div id="user-info" class="flex items-center">
 <div class="mr-3 text-sm text-right">
 <p class="font-medium user-name">Non connecté</p>
 <p class="text-gray-500 dark:text-gray-400 user-role"></p>
 </div>
 <button id="logout-button" class="hidden text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
 <i class="fas fa-sign-out-alt"></i>
 </button>
 </div>
 </div>
 </header>

 <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
 <div id="login-view" class="view-transition">
 <div class="max-w-md mx-auto bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden">
 <div class="p-6">
 <h2 class="text-2xl font-bold text-center mb-6">Connexion</h2>
 <div class="space-y-4">
 <div>
 <label for="email" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Email</label>
 <input type="email" id="email" class="mt-1 text-base block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white" placeholder="Entrez votre email">
 </div>
 <div>
 <label for="password" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Mot de passe</label>
 <input type="password" id="password" class="mt-1 text-base block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white" placeholder="••••••••">
 </div>
 <div class="flex items-center justify-between">
 <div class="flex items-center">
 <input id="remember-me" type="checkbox" class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded">
 <label for="remember-me" class="ml-2 block text-sm text-gray-700 dark:text-gray-300">Se souvenir de moi</label>
 </div>
 <div class="text-sm">
 <a href="#" class="font-medium text-primary-600 hover:text-primary-500 dark:text-primary-400">Mot de passe oublié ?</a>
 </div>
 </div>
 <div>
 <button id="btn-login-email" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
 <i class="fas fa-sign-in-alt mr-2"></i> Se connecter
 </button>
 </div>
 <div class="relative">
 <div class="absolute inset-0 flex items-center">
 <div class="w-full border-t border-gray-300 dark:border-gray-600"></div>
 </div>
 <div class="relative flex justify-center text-sm">
 <span class="px-2 bg-white dark:bg-gray-800 text-gray-500 dark:text-gray-400">Ou continuer avec</span>
 </div>
 </div>
 <div>
 <button id="btn-login-google" class="w-full flex justify-center py-2 px-4 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
 <i class="fab fa-google mr-2"></i> Google
 </button>
 </div>
 </div>
 </div>
 </div>
 </div>

 <div id="employee-view" class="view-transition hidden space-y-8">
 <div class="bg-white dark:bg-gray-800 shadow rounded-lg overflow-hidden">
 <div class="p-6">
 <h2 class="text-lg font-semibold mb-6">Solde des congés</h2>
 <div id="leave-balance" class="grid grid-cols-1 md:grid-cols-3 gap-4">
 <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
 <p class="text-sm font-medium text-gray-700 dark:text-gray-300">Congé Annuel</p>
 <p id="annual-leave-balance" class="text-lg font-bold text-gray-900 dark:text-gray-100">0 jours</p>
 </div>
 <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
 <p class="text-sm font-medium text-gray-700 dark:text-gray-300">Congé Exceptionnel</p>
 <p id="exceptional-leave-balance" class="text-lg font-bold text-gray-900 dark:text-gray-100">0 jours</p>
 </div>
 <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
 <p class="text-sm font-medium text-gray-700 dark:text-gray-300">Congé Récupération</p>
 <p id="recovery-leave-balance" class="text-lg font-bold text-gray-900 dark:text-gray-100">0 jours</p>
 </div>
 </div>
 </div>
 </div>
 <div class="bg-white dark:bg-gray-800 shadow rounded-lg overflow-hidden">
 <div class="p-6">
 <h2 class="text-lg font-semibold mb-6">Nouvelle demande de congé</h2>
 <form id="leave-form" class="space-y-6">
 <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
 <div>
 <label for="leave-type" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Type de congé</label>
 <select id="leave-type" name="leave-type" required class="mt-1 text-base block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white">
 <option value="" disabled selected>Sélectionnez un type</option>
 <option value="Annuel">Annuel</option>
 <option value="Exceptionnel">Exceptionnel</option>
 <option value="Récupération">Récupération</option>
 </select>
 </div>
 <div>
 <label for="leave-start-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Date de sortie</label>
 <input type="date" id="leave-start-date" name="leave-start-date" required class="mt-1 text-base block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white">
 </div>
 <div>
 <label for="leave-end-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Date d'entrée</label>
 <input type="date" id="leave-end-date" name="leave-end-date" required class="mt-1 text-base block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white">
 </div>
 <div>
 <label for="leave-days" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Nombre de jours</label>
 <input type="number" id="leave-days" name="leave-days" readonly class="mt-1 text-base block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-gray-100 dark:bg-gray-600 dark:text-white">
 </div>
 </div>
 <div class="flex justify-end">
 <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
 <i class="fas fa-paper-plane mr-2"></i> Soumettre la demande
 </button>
 </div>
 </form>
 </div>
 </div>
 <div class="bg-white dark:bg-gray-800 shadow rounded-lg overflow-hidden">
 <div class="p-6">
 <h2 class="text-lg font-semibold mb-6">Nouvelle demande d'autorisation de sortie</h2>
 <form id="leave-request-form" class="space-y-6">
 <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
 <div>
 <label for="leave-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Date</label>
 <input type="date" id="leave-date" name="leave-date" required class="mt-1 text-base block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white">
 </div>
 <div>
 <label for="leave-reason" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Motif</label>
 <select id="leave-reason" name="leave-reason" required class="mt-1 text-base block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white">
 <option value="" disabled selected>Sélectionnez un motif</option>
 <option value="Rendez-vous médical">Rendez-vous médical</option>
 <option value="Urgence familiale">Urgence familiale</option>
 <option value="Course professionnelle">Course professionnelle</option>
 <option value="Autre">Autre</option>
 </select>
 </div>
 <div>
 <label for="leave-start-time" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Heure de sortie</label>
 <input type="time" id="leave-start-time" name="leave-start-time" required class="mt-1 text-base block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white">
 </div>
 <div>
 <label for="leave-end-time" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Heure de retour estimée</label>
 <input type="time" id="leave-end-time" name="leave-end-time" required class="mt-1 text-base block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white">
 </div>
 </div>
 <div id="other-reason-container" class="hidden">
 <label for="other-reason" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Précisez le motif</label>
 <textarea id="other-reason" name="other-reason" rows="3" class="mt-1 text-base block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white" placeholder="Détaillez votre motif..."></textarea>
 </div>
 <div class="flex justify-end">
 <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
 <i class="fas fa-paper-plane mr-2"></i> Soumettre la demande
 </button>
 </div>
 </form>
 </div>
 </div>
 <div class="bg-white dark:bg-gray-800 shadow rounded-lg overflow-hidden">
 <div class="p-6">
 <h2 class="text-lg font-semibold mb-6">Nouvelle demande d'avance sur salaire</h2>
 <form id="advance-request-form" class="space-y-6">
 <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
 <div>
 <label for="advance-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Date de la demande</label>
 <input type="date" id="advance-date" name="advance-date" required class="mt-1 text-base block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white">
 </div>
 <div>
 <label for="advance-amount" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Montant demandé</label>
 <input type="number" id="advance-amount" name="advance-amount" min="0" step="0.01" required class="mt-1 text-base block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white" placeholder="Entrez le montant">
 </div>
 </div>
 <div class="flex justify-end">
 <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
 <i class="fas fa-paper-plane mr-2"></i> Soumettre la demande
 </button>
 </div>
 </form>
 </div>
 </div>
 <div class="bg-white dark:bg-gray-800 shadow rounded-lg overflow-hidden">
 <div class="p-6">
 <h2 class="text-lg font-semibold mb-6">Historique des demandes</h2>
 <div class="overflow-x-auto">
 <table id="employee-requests-table" class="min-w-full custom-table">
 <thead class="bg-gray-50 dark:bg-gray-700">
 <tr>
 <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Type</th>
 <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Date</th>
 <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Détails</th>
 <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Statut</th>
 <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Commentaire</th>
 </tr>
 </thead>
 <tbody class="divide-y divide-gray-200 dark:divide-gray-600 bg-white dark:bg-gray-800"></tbody>
 </table>
 <div id="employee-no-requests" class="py-6 text-center text-gray-500 dark:text-gray-400">
 <p>Aucune demande pour le moment.</p>
 </div>
 </div>
 </div>
 </div>
 </div>

 <div id="manager-view" class="view-transition hidden space-y-8">
 <div class="bg-white dark:bg-gray-800 shadow rounded-lg overflow-hidden">
 <div class="p-6">
 <h2 class="text-lg font-semibold mb-6">Demandes en attente</h2>
 <div class="overflow-x-auto">
 <table id="pending-requests-table" class="min-w-full custom-table">
 <thead class="bg-gray-50 dark:bg-gray-700">
 <tr>
 <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Employé</th>
 <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Type</th>
 <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Date</th>
 <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Détails</th>
 <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Actions</th>
 </tr>
 </thead>
 <tbody class="divide-y divide-gray-200 dark:divide-gray-600 bg-white dark:bg-gray-800"></tbody>
 </table>
 <div id="manager-no-pending" class="py-6 text-center text-gray-500 dark:text-gray-400">
 <p>Aucune demande en attente pour le moment.</p>
 </div>
 </div>
 </div>
 </div>
 <div class="bg-white dark:bg-gray-800 shadow rounded-lg overflow-hidden">
 <div class="p-6">
 <h2 class="text-lg font-semibold mb-6">Historique des demandes traitées</h2>
 <div class="overflow-x-auto">
 <table id="processed-requests-table" class="min-w-full custom-table">
 <thead class="bg-gray-50 dark:bg-gray-700">
 <tr>
 <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Employé</th>
 <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Type</th>
 <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Date</th>
 <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Détails</th>
 <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Statut</th>
 <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Commentaire</th>
 </tr>
 </thead>
 <tbody class="divide-y divide-gray-200 dark:divide-gray-600 bg-white dark:bg-gray-800"></tbody>
 </table>
 <div id="manager-no-processed" class="py-6 text-center text-gray-500 dark:text-gray-400">
 <p>Aucune demande traitée pour le moment.</p>
 </div>
 </div>
 </div>
 </div>
 <div class="bg-white dark:bg-gray-800 shadow rounded-lg overflow-hidden">
 <div class="p-6">
 <h2 class="text-lg font-semibold mb-6">Gestion des utilisateurs</h2>
 <div class="space-y-4">
 <div class="flex items-center space-x-4">
 <button id="add-user-btn" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
 <i class="fas fa-user-plus mr-2"></i> Ajouter un utilisateur
 </button>
 </div>
 <div class="overflow-x-auto">
 <table id="users-table" class="min-w-full custom-table">
 <thead class="bg-gray-50 dark:bg-gray-700">
 <tr>
 <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">ID</th>
 <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Nom</th>
 <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Email</th>
 <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Rôle</th>
 <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Actions</th>
 </tr>
 </thead>
 <tbody class="divide-y divide-gray-200 dark:divide-gray-600 bg-white dark:bg-gray-800"></tbody>
 </table>
 </div>
 <div class="flex items-center space-x-4">
 <input type="file" id="excel-upload" accept=".xlsx, .xls" class="hidden">
 <label for="excel-upload" class="file-input-label text-sm font-medium text-gray-700 dark:text-gray-300">
 <i class="fas fa-file-excel mr-2"></i> Sélectionner un fichier Excel (Utilisateurs)
 </label>
 <button id="import-excel-btn" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
 <i class="fas fa-upload mr-2"></i> Importer Utilisateurs
 </button>
 </div>
 <p class="text-sm text-gray-500 dark:text-gray-400">Importez un fichier Excel contenant les utilisateurs (colonnes : id, name, email, role, password).</p>
 <div class="flex items-center space-x-4">
 <input type="file" id="leave-balance-upload" accept=".xlsx, .xls" class="hidden">
 <label for="leave-balance-upload" class="file-input-label text-sm font-medium text-gray-700 dark:text-gray-300">
 <i class="fas fa-file-excel mr-2"></i> Sélectionner un fichier Excel (Soldes des congés)
 </label>
 <button id="import-leave-balance-btn" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
 <i class="fas fa-upload mr-2"></i> Importer Soldes
 </button>
 </div>
 <p class="text-sm text-gray-500 dark:text-gray-400">Importez un fichier Excel contenant les soldes des congés (colonnes : id, name, email, annual_leave, exceptional_leave, recovery_leave).</p>
 </div>
 </div>
 </div>
 <div class="bg-white dark:bg-gray-800 shadow rounded-lg overflow-hidden">
 <div class="p-6">
 <h2 class="text-lg font-semibold mb-6">Exportation des données</h2>
 <button id="export-data-btn" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
 <i class="fas fa-download mr-2"></i> Exporter les données
 </button>
 <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">Cliquez sur "Exporter" pour télécharger un fichier Excel avec les utilisateurs, soldes et demandes.</p>
 </div>
 </div>
 <div class="bg-white dark:bg-gray-800 shadow rounded-lg overflow-hidden">
 <div class="p-6">
 <h2 class="text-lg font-semibold mb-6">Synchronisation des données</h2>
 <div class="flex flex-col md:flex-row gap-4">
   <button id="sync-data-btn" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
     <i class="fas fa-sync-alt mr-2"></i> Synchroniser maintenant
   </button>
   <button id="reset-data-btn" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
     <i class="fas fa-trash-alt mr-2"></i> Réinitialiser les données
   </button>
 </div>
 <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">
   Synchronisez les données pour les enregistrer sur le serveur et permettre l'accès depuis d'autres appareils.
   <br>Cliquez sur "Réinitialiser" pour effacer toutes les données et revenir aux valeurs par défaut.
 </p>
 </div>
 </div>
 </div>
 </main>

 <div id="modal-container" class="fixed inset-0 z-10 overflow-y-auto hidden">
 <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
 <div class="fixed inset-0 transition-opacity" aria-hidden="true">
 <div class="absolute inset-0 bg-gray-500 dark:bg-gray-900 opacity-75"></div>
 </div>
 <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true"></span>
 <div id="modal-content" class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full"></div>
 </div>
 </div>

 <script>
 // Configuration Firebase mise à jour pour Firestore
 const firebaseConfig = {
   apiKey: "AIzaSyAk3qhQnJEqi2e5BQrydTFhPqoohHfVbzY",
   authDomain: "gestion-conges-app.firebaseapp.com",
   projectId: "gestion-conges-app",
   storageBucket: "gestion-conges-app.firebasestorage.app",
   messagingSenderId: "287763855046",
   appId: "1:287763855046:web:e70201a570dda13f7589c7"
 };

 // Vérification du chargement de Firebase
 if (typeof firebase === 'undefined') {
   console.error("Firebase SDK n'est pas chargé.");
   alert("Erreur : Impossible de charger Firebase. Vérifiez votre connexion ou les scripts.");
 } else {
   // Initialiser Firebase
   const app = firebase.initializeApp(firebaseConfig);
   const auth = firebase.auth();
   const db = firebase.firestore();
   console.log("Firebase initialisé avec succès");
 }

 // Structure des données de l'application
 const appData = {
   users: [],
   requests: [],
   leaveBalances: {},
   currentUser: null,
   lastSync: null,
   pendingChanges: [],
   isOnline: navigator.onLine
 };

 // Configuration du stockage local avec localForage
 const localDB = {
   async initializeStorage() {
     this.users = localforage.createInstance({ name: 'congés-app', storeName: 'users' });
     this.requests = localforage.createInstance({ name: 'congés-app', storeName: 'requests' });
     this.leaveBalances = localforage.createInstance({ name: 'congés-app', storeName: 'leaveBalances' });
     this.metadata = localforage.createInstance({ name: 'congés-app', storeName: 'metadata' });
     this.pendingQueue = localforage.createInstance({ name: 'congés-app', storeName: 'pendingQueue' });
   },
   async saveUsers(users) { await this.users.setItem('allUsers', users); },
   async getUsers() { return await this.users.getItem('allUsers') || []; },
   async saveRequests(requests) { await this.requests.setItem('allRequests', requests); },
   async getRequests() { return await this.requests.getItem('allRequests') || []; },
   async saveLeaveBalances(balances) { await this.leaveBalances.setItem('allBalances', balances); },
   async getLeaveBalances() { return await this.leaveBalances.getItem('allBalances') || {}; },
   async saveLastSync(timestamp) { await this.metadata.setItem('lastSync', timestamp); },
   async getLastSync() { return await this.metadata.getItem('lastSync'); },
   async saveCurrentUser(user) { await this.metadata.setItem('currentUser', user); },
   async getCurrentUser() { return await this.metadata.getItem('currentUser'); },
   async addPendingOperation(operation) {
     const queue = await this.pendingQueue.getItem('operations') || [];
     queue.push({ ...operation, timestamp: new Date().toISOString() });
     await this.pendingQueue.setItem('operations', queue);
   },
   async getPendingOperations() { return await this.pendingQueue.getItem('operations') || []; },
   async clearPendingOperations() { await this.pendingQueue.setItem('operations', []); },
   async removePendingOperation(index) {
     const queue = await this.pendingQueue.getItem('operations') || [];
     if (index >= 0 && index < queue.length) {
       queue.splice(index, 1);
       await this.pendingQueue.setItem('operations', queue);
     }
   }
 };

 // Afficher l'overlay de chargement
 function showLoading(message, details) {
   const overlay = document.getElementById('loading-overlay');
   document.getElementById('loading-message').textContent = message || "Chargement...";
   document.getElementById('loading-details').textContent = details || "Veuillez patienter...";
   overlay.classList.remove('hidden');
 }

 // Masquer l'overlay de chargement
 function hideLoading() {
   document.getElementById('loading-overlay').classList.add('hidden');
 }

 // Mettre à jour le badge de statut de synchronisation
 function updateSyncStatus(status, message) {
   const badge = document.getElementById('sync-status');
   const text = document.getElementById('sync-text');
   badge.className = "sync-badge";
   switch(status) {
     case 'online':
       badge.classList.add('online');
       badge.innerHTML = '<i class="fas fa-cloud-upload-alt"></i>';
       text.textContent = message || "Synchronisé";
       break;
     case 'offline':
       badge.classList.add('offline');
       badge.innerHTML = '<i class="fas fa-cloud-slash"></i>';
       text.textContent = message || "Hors ligne";
       break;
     case 'syncing':
       badge.classList.add('syncing');
       badge.innerHTML = '<i class="fas fa-sync-alt spin"></i>';
       text.textContent = message || "Synchronisation...";
       break;
     default:
       badge.classList.add('offline');
       badge.innerHTML = '<i class="fas fa-question-circle"></i>';
       text.textContent = "Statut inconnu";
   }
 }

 // Afficher une notification
 function showNotification(message, type) {
   const container = document.getElementById('notification-container');
   const notification = document.createElement('div');
   notification.className = `notification px-4 py-2 rounded-md shadow-lg text-white ${
     type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-500' : 'bg-blue-500'
   }`;
   notification.textContent = message;
   container.appendChild(notification);
   setTimeout(() => notification.remove(), 3000);
 }

 // Afficher une modale
 function showModal(title, content, actions) {
   const modalContainer = document.getElementById('modal-container');
   const modalContent = document.getElementById('modal-content');
   modalContent.innerHTML = `
     <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-600">
       <h3 class="text-lg font-medium text-gray-900 dark:text-white">${title}</h3>
     </div>
     <div class="px-6 py-4">${content}</div>
     <div class="px-6 py-4 bg-gray-50 dark:bg-gray-700 flex justify-end space-x-2">${actions}</div>
   `;
   modalContainer.classList.remove('hidden');
   modalContainer.querySelectorAll('.modal-close').forEach(btn => {
     btn.addEventListener('click', closeModal);
   });
 }

 // Fermer une modale
 function closeModal() {
   document.getElementById('modal-container').classList.add('hidden');
 }

 // Hacher les mots de passe
 async function hashPassword(password) {
   const encoder = new TextEncoder();
   const data = encoder.encode(password);
   const hash = await crypto.subtle.digest('SHA-256', data);
   return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
 }

 // Enregistrer les modifications locales
 async function saveToLocalStorage() {
   try {
     await localDB.saveUsers(appData.users);
     await localDB.saveRequests(appData.requests);
     await localDB.saveLeaveBalances(appData.leaveBalances);
     await localDB.saveLastSync(appData.lastSync);
     if (appData.currentUser) await localDB.saveCurrentUser(appData.currentUser);
     console.log("Données sauvegardées localement");
   } catch (error) {
     console.error("Erreur lors de la sauvegarde locale:", error);
     showNotification("Erreur lors de la sauvegarde locale.", "error");
   }
 }

 // Charger les données depuis le stockage local
 async function loadFromLocalStorage() {
   try {
     const users = await localDB.getUsers();
     if (users.length > 0) appData.users = users;
     const requests = await localDB.getRequests();
     if (requests.length > 0) appData.requests = requests;
     const leaveBalances = await localDB.getLeaveBalances();
     if (Object.keys(leaveBalances).length > 0) appData.leaveBalances = leaveBalances;
     const lastSync = await localDB.getLastSync();
     if (lastSync) appData.lastSync = lastSync;
     const currentUser = await localDB.getCurrentUser();
     if (currentUser) appData.currentUser = currentUser;
     console.log("Données chargées depuis le stockage local");
     if (appData.users.length === 0) await createDefaultData();
     return true;
   } catch (error) {
     console.error("Erreur lors du chargement local:", error);
     return false;
   }
 }

 // Créer les données par défaut
 async function createDefaultData() {
   const defaultUsers = [
     { id: 76, name: "ALILI HOUSSEM", email: "alilihoussem@easywayelecto.com", role: "Responsable", password: "1234" },
     { id: 1, name: "John Doe", email: "john.doe@example.com", role: "Employé", password: "1234" }
   ];
   appData.users = await Promise.all(defaultUsers.map(async u => ({
     ...u,
     password: await hashPassword(u.password)
   })));
   appData.requests = [];
   appData.leaveBalances = {};
   for (const user of appData.users) {
     if (user.role === "Employé") initializeLeaveBalances(user.id);
   }
   await saveToLocalStorage();
 }

 // Écouteurs d'état de connexion réseau
 function setupNetworkListeners() {
   window.addEventListener('online', () => {
     appData.isOnline = true;
     updateSyncStatus('online', 'Connexion rétablie');
     processPendingOperations();
   });
   window.addEventListener('offline', () => {
     appData.isOnline = false;
     updateSyncStatus('offline', 'Hors ligne');
   });
 }

 // Firebase - Récupérer les utilisateurs
 async function fetchUsersFromFirebase() {
   try {
     const snapshot = await db.collection('users').get();
     const users = snapshot.docs.map(doc => doc.data());
     console.log("Utilisateurs récupérés depuis Firestore:", users);
     return users;
   } catch (error) {
     console.error('Erreur lors de la récupération des utilisateurs:', error);
     throw error;
   }
 }

 // Firebase - Récupérer les demandes
 async function fetchRequestsFromFirebase() {
   try {
     const snapshot = await db.collection('requests').get();
     const requests = snapshot.docs.map(doc => doc.data());
     console.log("Demandes récupérées depuis Firestore:", requests);
     return requests;
   } catch (error) {
     console.error('Erreur lors de la récupération des demandes:', error);
     throw error;
   }
 }

 // Firebase - Récupérer les soldes de congés
 async function fetchLeaveBalancesFromFirebase() {
   try {
     const snapshot = await db.collection('leaveBalances').get();
     const balances = {};
     snapshot.docs.forEach(doc => {
       const data = doc.data();
       balances[data.userId] = {
         annual: data.annual,
         exceptional: data.exceptional,
         recovery: data.recovery
       };
     });
     console.log("Soldes récupérés depuis Firestore:", balances);
     return balances;
   } catch (error) {
     console.error('Erreur lors de la récupération des soldes:', error);
     throw error;
   }
 }

 // Firebase - Mettre à jour ou ajouter un utilisateur
 async function updateUserInFirebase(user) {
   try {
     await db.collection('users').doc(user.id.toString()).set(user);
     return true;
   } catch (error) {
     console.error(`Erreur mise à jour utilisateur ${user.id}:`, error);
     throw error;
   }
 }

 // Firebase - Mettre à jour ou ajouter une demande
 async function updateRequestInFirebase(request) {
   try {
     await db.collection('requests').doc(request.id.toString()).set(request);
     return true;
   } catch (error) {
     console.error(`Erreur mise à jour demande ${request.id}:`, error);
     throw error;
   }
 }

 // Firebase - Mettre à jour ou ajouter un solde de congés
 async function updateLeaveBalanceInFirebase(userId, balance) {
   try {
     await db.collection('leaveBalances').doc(userId.toString()).set({
       userId: userId,
       annual: balance.annual,
       exceptional: balance.exceptional,
       recovery: balance.recovery
     });
     return true;
   } catch (error) {
     console.error(`Erreur mise à jour solde utilisateur ${userId}:`, error);
     throw error;
   }
 }

 // Firebase - Supprimer un utilisateur
 async function deleteUserFromFirebase(userId) {
   try {
     await db.collection('users').doc(userId.toString()).delete();
     return true;
   } catch (error) {
     console.error(`Erreur suppression utilisateur ${userId}:`, error);
     throw error;
   }
 }

 // Firebase - Supprimer une demande
 async function deleteRequestFromFirebase(requestId) {
   try {
     await db.collection('requests').doc(requestId.toString()).delete();
     return true;
   } catch (error) {
     console.error(`Erreur suppression demande ${requestId}:`, error);
     throw error;
   }
 }

 // Firebase - Supprimer un solde de congés
 async function deleteLeaveBalanceFromFirebase(userId) {
   try {
     await db.collection('leaveBalances').doc(userId.toString()).delete();
     return true;
   } catch (error) {
     console.error(`Erreur suppression solde ${userId}:`, error);
     throw error;
   }
 }

 // Synchroniser toutes les données avec Firebase
 async function syncAllDataWithFirebase(forceSync = false) {
   if (!appData.isOnline) {
     showNotification("Vous êtes hors ligne. Les changements seront synchronisés plus tard.", "error");
     return;
   }
   updateSyncStatus('syncing', "Synchronisation en cours...");
   try {
     if (forceSync) showLoading("Synchronisation", "Mise à jour des données sur le serveur...");
     await processPendingOperations();
     for (const user of appData.users) await updateUserInFirebase(user);
     for (const request of appData.requests) await updateRequestInFirebase(request);
     for (const userId in appData.leaveBalances) await updateLeaveBalanceInFirebase(parseInt(userId), appData.leaveBalances[userId]);
     appData.lastSync = new Date().toISOString();
     await localDB.saveLastSync(appData.lastSync);
     updateSyncStatus('online', "Synchronisé");
     if (forceSync) {
       hideLoading();
       showNotification("Synchronisation réussie !", "success");
     }
   } catch (error) {
     console.error("Erreur synchronisation Firebase:", error);
     updateSyncStatus('offline', "Échec synchronisation");
     if (forceSync) {
       hideLoading();
       showNotification("Échec synchronisation. Données locales conservées.", "error");
     }
   }
 }

 // Récupérer toutes les données depuis Firebase
 async function fetchAllDataFromFirebase() {
   if (!appData.isOnline) {
     showNotification("Hors ligne. Utilisation des données locales.", "error");
     return false;
   }
   showLoading("Récupération des données", "Connexion au serveur...");
   updateSyncStatus('syncing', "Récupération...");
   try {
     const [users, requests, leaveBalances] = await Promise.all([
       fetchUsersFromFirebase(),
       fetchRequestsFromFirebase(),
       fetchLeaveBalancesFromFirebase()
     ]);
     if (users.length > 0) appData.users = users;
     if (requests.length > 0) appData.requests = requests;
     if (Object.keys(leaveBalances).length > 0) appData.leaveBalances = leaveBalances;
     appData.lastSync = new Date().toISOString();
     await saveToLocalStorage();
     updateSyncStatus('online', "Données récupérées");
     hideLoading();
     if (appData.currentUser) {
       if (appData.currentUser.role === "Employé") {
         updateLeaveBalanceDisplay();
         updateEmployeeRequestsTable();
       } else if (appData.currentUser.role === "Responsable") {
         updateManagerRequestsTables();
         updateUsersTable();
       }
     }
     return true;
   } catch (error) {
     console.error("Erreur récupération Firebase:", error);
     updateSyncStatus('offline', "Échec connexion");
     hideLoading();
     showNotification("Impossible de se connecter au serveur.", "error");
     return false;
   }
 }

 // Ajouter une opération à la file d'attente
 async function queueOperation(operation) {
   await localDB.addPendingOperation(operation);
   if (appData.isOnline) processPendingOperations();
 }

 // Traiter les opérations en attente
 async function processPendingOperations() {
   if (!appData.isOnline) return;
   updateSyncStatus('syncing', "Traitement des modifications...");
   try {
     const operations = await localDB.getPendingOperations();
     if (operations.length === 0) {
       updateSyncStatus('online', "Synchronisé");
       return;
     }
     for (let i = 0; i < operations.length; i++) {
       const op = operations[i];
       let success = false;
       switch (op.type) {
         case 'addUser':
         case 'updateUser':
           success = await updateUserInFirebase(op.data);
           break;
         case 'deleteUser':
           success = await deleteUserFromFirebase(op.data.id);
           break;
         case 'addRequest':
         case 'updateRequest':
           success = await updateRequestInFirebase(op.data);
           break;
         case 'deleteRequest':
           success = await deleteRequestFromFirebase(op.data.id);
           break;
         case 'updateLeaveBalance':
           success = await updateLeaveBalanceInFirebase(op.data.userId, op.data.balance);
           break;
         case 'deleteLeaveBalance':
           success = await deleteLeaveBalanceFromFirebase(op.data.userId);
           break;
       }
       if (success) {
         await localDB.removePendingOperation(i);
         i--;
       }
     }
     const remainingOps = await localDB.getPendingOperations();
     updateSyncStatus(remainingOps.length === 0 ? 'online' : 'offline', remainingOps.length === 0 ? "Synchronisé" : `${remainingOps.length} changements en attente`);
   } catch (error) {
     console.error("Erreur traitement opérations:", error);
     updateSyncStatus('offline', "Échec synchronisation");
   }
 }

 // Synchronisation périodique
 function setupPeriodicSync() {
   setInterval(() => {
     if (appData.currentUser && appData.isOnline) processPendingOperations();
   }, 300000); // 5 minutes
   window.addEventListener('beforeunload', () => {
     if (appData.currentUser) saveToLocalStorage();
   });
 }

 // Initialiser les soldes de congés
 function initializeLeaveBalances(userId) {
   if (!appData.leaveBalances[userId]) {
     appData.leaveBalances[userId] = { annual: 20, exceptional: 5, recovery: 10 };
     saveToLocalStorage();
     queueOperation({
       type: 'updateLeaveBalance',
       data: { userId: userId, balance: appData.leaveBalances[userId] }
     });
   }
 }

 // Mettre à jour l'affichage des soldes
 function updateLeaveBalanceDisplay() {
   if (!appData.currentUser || appData.currentUser.role !== "Employé") return;
   const userId = appData.currentUser.id;
   initializeLeaveBalances(userId);
   document.getElementById('annual-leave-balance').textContent = `${appData.leaveBalances[userId].annual} jours`;
   document.getElementById('exceptional-leave-balance').textContent = `${appData.leaveBalances[userId].exceptional} jours`;
   document.getElementById('recovery-leave-balance').textContent = `${appData.leaveBalances[userId].recovery} jours`;
 }

 // Calculer les jours entre deux dates
 function calculateDaysBetweenDates(startDate, endDate) {
   const start = new Date(startDate);
   const end = new Date(endDate);
   const diffTime = Math.abs(end - start);
   return Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
 }

 // Formater une date
 function formatDate(dateStr) {
   const options = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
   return new Date(dateStr).toLocaleDateString('fr-FR', options);
 }

 // Obtenir la classe CSS pour un statut
 function getStatusClass(status) {
   switch(status) {
     case "En attente": return "status-pending";
     case "Approuvée": return "status-approved";
     case "Refusée": return "status-rejected";
     default: return "";
   }
 }

 // Obtenir l'icône pour un statut
 function getStatusIcon(status) {
   switch(status) {
     case "En attente": return '<i class="fas fa-hourglass-half mr-1"></i>';
     case "Approuvée": return '<i class="fas fa-check mr-1"></i>';
     case "Refusée": return '<i class="fas fa-times mr-1"></i>';
     default: return '';
   }
 }

 // Obtenir un utilisateur par ID
 function getUserById(userId) {
   const user = appData.users.find(u => u.id === userId);
   return user || { name: "Employé inconnu", email: "" };
 }

 // Afficher une vue spécifique
 function showView(viewId) {
   document.querySelectorAll('.view-transition').forEach(view => view.classList.add('hidden'));
   document.getElementById(viewId).classList.remove('hidden');
 }

 // Configuration du formulaire de congé
 function setupLeaveForm() {
   const form = document.getElementById('leave-form');
   const startDateInput = document.getElementById('leave-start-date');
   const endDateInput = document.getElementById('leave-end-date');
   const daysInput = document.getElementById('leave-days');

   function updateDays() {
     const start = startDateInput.value;
     const end = endDateInput.value;
     if (start && end && new Date(start) <= new Date(end)) {
       daysInput.value = calculateDaysBetweenDates(start, end);
     } else {
       daysInput.value = '';
     }
   }

   startDateInput.addEventListener('change', updateDays);
   endDateInput.addEventListener('change', updateDays);

   form.addEventListener('submit', async (e) => {
     e.preventDefault();
     const type = document.getElementById('leave-type').value;
     const startDate = startDateInput.value;
     const endDate = endDateInput.value;
     const days = parseInt(daysInput.value);
     const today = new Date().toISOString().split('T')[0];

     if (startDate < today) {
       showNotification("La date de début ne peut pas être dans le passé.", "error");
       return;
     }
     if (endDate < startDate) {
       showNotification("La date de fin doit être après la date de début.", "error");
       return;
     }

     const balanceKey = type.toLowerCase();
     const userId = appData.currentUser.id;
     initializeLeaveBalances(userId);
     if (appData.leaveBalances[userId][balanceKey] < days) {
       showNotification("Solde de congé insuffisant.", "error");
       return;
     }

     const newRequest = {
       id: Date.now(),
       type: `Congé ${type}`,
       leaveType: type,
       date: startDate,
       details: `Du ${formatDate(startDate)} au ${formatDate(endDate)} (${days} jours)`,
       days: days,
       status: "En attente",
       employeeId: userId,
       managerId: 76,
       createdAt: new Date().toISOString(),
       comment: ""
     };

     appData.requests.push(newRequest);
     await saveToLocalStorage();
     queueOperation({ type: 'addRequest', data: newRequest });
     form.reset();
     updateEmployeeRequestsTable();
     showNotification("Demande de congé soumise avec succès.", "success");
   });
 }

 // Configuration du formulaire d'autorisation de sortie
 function setupLeaveRequestForm() {
   const form = document.getElementById('leave-request-form');
   const reasonSelect = document.getElementById('leave-reason');
   const otherReasonContainer = document.getElementById('other-reason-container');

   reasonSelect.addEventListener('change', () => {
     otherReasonContainer.classList.toggle('hidden', reasonSelect.value !== "Autre");
   });

   form.addEventListener('submit', async (e) => {
     e.preventDefault();
     const date = document.getElementById('leave-date').value;
     const reason = reasonSelect.value;
     const startTime = document.getElementById('leave-start-time').value;
     const endTime = document.getElementById('leave-end-time').value;
     const otherReason = document.getElementById('other-reason')?.value.trim() || "";
     const today = new Date().toISOString().split('T')[0];

     if (date < today) {
       showNotification("La date ne peut pas être dans le passé.", "error");
       return;
     }
     if (startTime >= endTime) {
       showNotification("L'heure de retour doit être après l'heure de sortie.", "error");
       return;
     }

     const details = reason === "Autre" ? otherReason : reason;
     const newRequest = {
       id: Date.now(),
       type: "Autorisation de sortie",
       date,
       details: `${details} de ${startTime} à ${endTime}`,
       status: "En attente",
       employeeId: appData.currentUser.id,
       managerId: 76,
       createdAt: new Date().toISOString(),
       comment: ""
     };

     appData.requests.push(newRequest);
     await saveToLocalStorage();
     queueOperation({ type: 'addRequest', data: newRequest });
     form.reset();
     otherReasonContainer.classList.add('hidden');
     updateEmployeeRequestsTable();
     showNotification("Demande d'autorisation soumise avec succès.", "success");
   });
 }

 // Configuration du formulaire d'avance sur salaire
 function setupAdvanceRequestForm() {
   const form = document.getElementById('advance-request-form');
   form.addEventListener('submit', async (e) => {
     e.preventDefault();
     const date = document.getElementById('advance-date').value;
     const amount = parseFloat(document.getElementById('advance-amount').value);
     const today = new Date().toISOString().split('T')[0];

     if (date < today) {
       showNotification("La date ne peut pas être dans le passé.", "error");
       return;
     }
     if (amount <= 0) {
       showNotification("Le montant doit être supérieur à 0.", "error");
       return;
     }

     const newRequest = {
       id: Date.now(),
       type: "Avance sur salaire",
       date,
       details: `Montant : ${amount} €`,
       status: "En attente",
       employeeId: appData.currentUser.id,
       managerId: 76,
       createdAt: new Date().toISOString(),
       comment: ""
     };

     appData.requests.push(newRequest);
     await saveToLocalStorage();
     queueOperation({ type: 'addRequest', data: newRequest });
     form.reset();
     updateEmployeeRequestsTable();
     showNotification("Demande d'avance soumise avec succès.", "success");
   });
 }

 // Mettre à jour le tableau des demandes employé
 function updateEmployeeRequestsTable() {
   if (!appData.currentUser || appData.currentUser.role !== "Employé") return;
   const tableBody = document.querySelector('#employee-requests-table tbody');
   const noRequestsMessage = document.getElementById('employee-no-requests');
   const employeeRequests = appData.requests.filter(req => req.employeeId === appData.currentUser.id)
     .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

   if (employeeRequests.length === 0) {
     tableBody.innerHTML = '';
     noRequestsMessage.style.display = 'block';
     return;
   }

   noRequestsMessage.style.display = 'none';
   tableBody.innerHTML = employeeRequests.map(req => `
     <tr>
       <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">${req.type}</td>
       <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">${formatDate(req.date)}</td>
       <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">${req.details}</td>
       <td class="px-6 py-4 whitespace-nowrap">
         <span class="status-badge ${getStatusClass(req.status)}">${getStatusIcon(req.status)} ${req.status}</span>
       </td>
       <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${req.comment}</td>
     </tr>
   `).join('');
 }

 // Mettre à jour les tableaux des demandes manager
 function updateManagerRequestsTables() {
   if (!appData.currentUser || appData.currentUser.role !== "Responsable") return;
   const pendingTableBody = document.querySelector('#pending-requests-table tbody');
   const noPendingMessage = document.getElementById('manager-no-pending');
   const pendingRequests = appData.requests.filter(req => req.status === "En attente")
     .sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));

   if (pendingRequests.length === 0) {
     pendingTableBody.innerHTML = '';
     noPendingMessage.style.display = 'block';
   } else {
     noPendingMessage.style.display = 'none';
     pendingTableBody.innerHTML = pendingRequests.map(req => {
       const employee = getUserById(req.employeeId);
       return `
         <tr>
           <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">${employee.name}</td>
           <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">${req.type}</td>
           <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">${formatDate(req.date)}</td>
           <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">${req.details}</td>
           <td class="px-6 py-4 whitespace-nowrap text-sm">
             <div class="flex space-x-2">
               <button data-request-id="${req.id}" class="approve-btn px-3 py-1 bg-green-100 text-green-800 dark:bg-green-800 dark:text-green-100 rounded-md hover:bg-green-200 dark:hover:bg-green-700">
                 <i class="fas fa-check mr-1"></i> Approuver
               </button>
               <button data-request-id="${req.id}" class="reject-btn px-3 py-1 bg-red-100 text-red-800 dark:bg-red-800 dark:text-red-100 rounded-md hover:bg-red-200 dark:hover:bg-red-700">
                 <i class="fas fa-times mr-1"></i> Refuser
               </button>
             </div>
           </td>
         </tr>
       `;
     }).join('');

     pendingTableBody.querySelectorAll('.approve-btn').forEach(button => {
       button.removeEventListener('click', approveRequestHandler); // Nettoyage
       button.addEventListener('click', approveRequestHandler);
     });

     pendingTableBody.querySelectorAll('.reject-btn').forEach(button => {
       button.removeEventListener('click', rejectRequestHandler);
       button.addEventListener('click', rejectRequestHandler);
     });
   }

   const processedTableBody = document.querySelector('#processed-requests-table tbody');
   const noProcessedMessage = document.getElementById('manager-no-processed');
   const processedRequests = appData.requests.filter(req => req.status !== "En attente")
     .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

   if (processedRequests.length === 0) {
     processedTableBody.innerHTML = '';
     noProcessedMessage.style.display = 'block';
   } else {
     noProcessedMessage.style.display = 'none';
     processedTableBody.innerHTML = processedRequests.map(req => {
       const employee = getUserById(req.employeeId);
       return `
         <tr>
           <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">${employee.name}</td>
           <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">${req.type}</td>
           <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">${formatDate(req.date)}</td>
           <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">${req.details}</td>
           <td class="px-6 py-4 whitespace-nowrap">
             <span class="status-badge ${getStatusClass(req.status)}">${getStatusIcon(req.status)} ${req.status}</span>
           </td>
           <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${req.comment}</td>
         </tr>
       `;
     }).join('');
   }
 }

 function approveRequestHandler(e) {
   const requestId = parseInt(e.target.closest('button').getAttribute('data-request-id'));
   approveRequest(requestId);
 }

 function rejectRequestHandler(e) {
   const requestId = parseInt(e.target.closest('button').getAttribute('data-request-id'));
   showRejectModal(requestId);
 }

 // Mettre à jour le tableau des utilisateurs
 function updateUsersTable() {
   if (!appData.currentUser || appData.currentUser.role !== "Responsable") return;
   const tableBody = document.querySelector('#users-table tbody');
   tableBody.innerHTML = appData.users.map(user => `
     <tr>
       <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">${user.id}</td>
       <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">${user.name}</td>
       <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">${user.email}</td>
       <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">${user.role}</td>
       <td class="px-6 py-4 whitespace-nowrap text-sm">
         <div class="flex space-x-2">
           <button data-user-id="${user.id}" class="edit-user-btn px-3 py-1 bg-blue-100 text-blue-800 dark:bg-blue-800 dark:text-blue-100 rounded-md hover:bg-blue-200 dark:hover:bg-blue-700">
             <i class="fas fa-edit mr-1"></i> Modifier
           </button>
           <button data-user-id="${user.id}" class="delete-user-btn px-3 py-1 bg-red-100 text-red-800 dark:bg-red-800 dark:text-red-100 rounded-md hover:bg-red-200 dark:hover:bg-red-700">
             <i class="fas fa-trash-alt mr-1"></i> Supprimer
           </button>
         </div>
       </td>
     </tr>
   `).join('');

   tableBody.querySelectorAll('.edit-user-btn').forEach(button => {
     button.removeEventListener('click', editUserHandler);
     button.addEventListener('click', editUserHandler);
   });

   tableBody.querySelectorAll('.delete-user-btn').forEach(button => {
     button.removeEventListener('click', deleteUserHandler);
     button.addEventListener('click', deleteUserHandler);
   });
 }

 function editUserHandler(e) {
   const userId = parseInt(e.target.closest('button').getAttribute('data-user-id'));
   showEditUserModal(userId);
 }

 function deleteUserHandler(e) {
   const userId = parseInt(e.target.closest('button').getAttribute('data-user-id'));
   showDeleteUserModal(userId);
 }

 // Approuver une demande
 async function approveRequest(requestId) {
   const request = appData.requests.find(req => req.id === requestId);
   if (!request) return;
   request.status = "Approuvée";
   request.comment = "";
   if (request.type.startsWith("Congé")) {
     const userId = request.employeeId;
     initializeLeaveBalances(userId);
     const balanceKey = request.leaveType.toLowerCase();
     appData.leaveBalances[userId][balanceKey] -= request.days;
     if (appData.currentUser?.id === userId && appData.currentUser.role === "Employé") {
       updateLeaveBalanceDisplay();
     }
     queueOperation({
       type: 'updateLeaveBalance',
       data: { userId: userId, balance: appData.leaveBalances[userId] }
     });
   }
   queueOperation({ type: 'updateRequest', data: request });
   await saveToLocalStorage();
   updateManagerRequestsTables();
   updateEmployeeRequestsTable();
   showNotification(`Demande de ${getUserById(request.employeeId).name} approuvée.`, "success");
 }

 // Afficher la modale de rejet
 function showRejectModal(requestId) {
   const request = appData.requests.find(req => req.id === requestId);
   if (!request) return;
   const employee = getUserById(request.employeeId);
   const modalContent = `
     <p class="text-gray-700 dark:text-gray-300">
       Refus de la demande de ${employee.name} pour le ${formatDate(request.date)}.
     </p>
     <div class="mt-4">
       <label for="reject-reason" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Motif (optionnel)</label>
       <textarea id="reject-reason" rows="3" class="mt-1 text-base block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white" placeholder="Raison du refus..."></textarea>
     </div>
   `;
   const modalActions = `
     <button id="confirm-reject" class="inline-flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
       Confirmer le refus
     </button>
     <button class="modal-close inline-flex justify-center py-2 px-4 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
       Annuler
     </button>
   `;
   showModal(`Refuser la demande`, modalContent, modalActions);
   document.getElementById('confirm-reject').addEventListener('click', function() {
     rejectRequest(requestId, document.getElementById('reject-reason').value.trim());
     closeModal();
   });
 }

 // Rejet d'une demande
 async function rejectRequest(requestId, comment = "") {
   const request = appData.requests.find(req => req.id === requestId);
   if (!request) return;
   request.status = "Refusée";
   request.comment = comment;
   
   // Ajouter à la file d'attente de synchronisation
   queueOperation({
     type: 'updateRequest',
     data: request
   });
   
   await saveToLocalStorage();
   updateManagerRequestsTables();
   updateEmployeeRequestsTable();
   showNotification(`La demande de ${getUserById(request.employeeId).name} a été refusée.`, "success");
 }

 // Configuration du formulaire de connexion
 function setupLoginForm() {
   document.getElementById('btn-login-email').addEventListener('click', async function(e) {
     e.preventDefault();
     const email = document.getElementById('email').value.trim();
     const password = document.getElementById('password').value;

     if (!email) return showNotification("Veuillez entrer votre email.", "error");
     if (!password) return showNotification("Veuillez entrer votre mot de passe.", "error");

     try {
       const hashedPassword = await hashPassword(password);
       const user = appData.users.find(u => u.email.toLowerCase() === email.toLowerCase() && u.password === hashedPassword);
       if (user) {
         login(user);
       } else {
         showNotification("Email ou mot de passe incorrect. Veuillez réessayer.", "error");
       }
     } catch (error) {
       console.error("Erreur lors de la connexion:", error);
       showNotification("Une erreur est survenue lors de la connexion.", "error");
     }
   });

   document.getElementById('btn-login-google').addEventListener('click', function(e) {
     e.preventDefault();
     showNotification("Fonction de connexion Google non disponible dans cette démo.", "info");
   });

   document.getElementById('logout-button').addEventListener('click', logout);
 }

 // Connexion d'un utilisateur
 async function login(user) {
   appData.currentUser = user;
   initializeLeaveBalances(user.id);
   document.querySelector('.user-name').textContent = user.name;
   document.querySelector('.user-role').textContent = user.role;
   document.getElementById('logout-button').classList.remove('hidden');
   showView(user.role === "Employé" ? 'employee-view' : 'manager-view');
   
   // Enregistrer l'utilisateur connecté dans le stockage local
   await localDB.saveCurrentUser(user);
   
   showNotification(`Bienvenue, ${user.name} !`, "success");
   
   // Tentative de synchronisation au login
   if (appData.isOnline) {
     fetchAllDataFromFirebase().catch(() => {
       console.log("Impossible de récupérer les données du serveur, utilisation des données locales");
     });
   }
 }

 // Déconnexion de l'utilisateur
 async function logout() {
   appData.currentUser = null;
   await localDB.saveCurrentUser(null);
   document.querySelector('.user-name').textContent = "Non connecté";
   document.querySelector('.user-role').textContent = "";
   document.getElementById('logout-button').classList.add('hidden');
   showView('login-view');
   showNotification("Vous avez été déconnecté.", "info");
 }

 // Configuration de l'importation Excel d'utilisateurs
 function setupExcelImport() {
   const importBtn = document.getElementById('import-excel-btn');
   const fileInput = document.getElementById('excel-upload');

   importBtn.addEventListener('click', async function() {
     const file = fileInput.files[0];
     if (!file) {
       showNotification("Veuillez sélectionner un fichier Excel.", "error");
       return;
     }

     const reader = new FileReader();
     reader.onload = async function(e) {
       try {
         const data = new Uint8Array(e.target.result);
         const workbook = XLSX.read(data, { type: 'array' });
         const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
         const jsonData = XLSX.utils.sheet_to_json(firstSheet);

         if (jsonData.length === 0) {
           showNotification("Le fichier Excel est vide.", "error");
           return;
         }

         const newUsersPromises = jsonData.map(async row => {
           if (!row.id || !row.name || !row.email || !row.role || !row.password) {
             showNotification("Certaines lignes du fichier Excel sont incomplètes.", "error");
             return null;
           }

           const role = row.role.toString().trim();
           if (role !== "Employé" && role !== "Responsable") {
             showNotification(`Le rôle "${role}" n'est pas valide. Les rôles autorisés sont "Employé" et "Responsable".`, "error");
             return null;
           }

           const existingUser = appData.users.find(u => u.id === parseInt(row.id));
           if (existingUser) {
             showNotification(`Un utilisateur avec l'id ${row.id} existe déjà.`, "error");
             return null;
           }

           return {
             id: parseInt(row.id),
             name: row.name.toString().trim(),
             email: row.email.toString().trim(),
             role: role,
             password: await hashPassword(row.password.toString().trim())
           };
         });

         const newUsers = (await Promise.all(newUsersPromises)).filter(user => user !== null);

         if (newUsers.length === 0) {
           showNotification("Aucun utilisateur valide n'a été trouvé dans le fichier Excel.", "error");
           return;
         }

         appData.users = [...appData.users, ...newUsers];
         
         // Ajouter les nouveaux utilisateurs à la file d'attente de synchronisation
         for (const user of newUsers) {
           queueOperation({
             type: 'addUser',
             data: user
           });
           
           if (user.role === "Employé") {
             initializeLeaveBalances(user.id);
           }
         }
         
         await saveToLocalStorage();
         fileInput.value = '';
         updateUsersTable();
         showNotification(`${newUsers.length} utilisateur(s) importé(s) avec succès.`, "success");
       } catch (error) {
         console.error("Erreur lors de l'importation Excel:", error);
         showNotification("Une erreur est survenue lors de l'importation du fichier Excel.", "error");
       }
     };
     reader.onerror = function() {
       showNotification("Erreur lors de la lecture du fichier.", "error");
     };
     reader.readAsArrayBuffer(file);
   });
 }

 // Configuration de l'importation Excel des soldes de congés
 function setupLeaveBalanceImport() {
   const importBtn = document.getElementById('import-leave-balance-btn');
   const fileInput = document.getElementById('leave-balance-upload');

   importBtn.addEventListener('click', function() {
     const file = fileInput.files[0];
     if (!file) {
       showNotification("Veuillez sélectionner un fichier Excel pour les soldes des congés.", "error");
       return;
     }

     const reader = new FileReader();
     reader.onload = function(e) {
       try {
         const data = new Uint8Array(e.target.result);
         const workbook = XLSX.read(data, { type: 'array' });
         const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
         const jsonData = XLSX.utils.sheet_to_json(firstSheet);

         if (jsonData.length === 0) {
           showNotification("Le fichier Excel des soldes est vide.", "error");
           return;
         }

         let updatedCount = 0;
         jsonData.forEach(row => {
           if (!row.id || !row.email || row.annual_leave === undefined || row.exceptional_leave === undefined || row.recovery_leave === undefined) {
             showNotification("Certaines lignes du fichier Excel des soldes sont incomplètes.", "error");
             return;
           }

           const userId = parseInt(row.id);
           const user = appData.users.find(u => u.id === userId && u.email.toLowerCase() === row.email.toString().trim().toLowerCase());
           if (!user) {
             showNotification(`Utilisateur avec id ${userId} et email ${row.email} non trouvé dans la liste des utilisateurs.`, "error");
             return;
           }

           if (user.role !== "Employé") {
             showNotification(`L'utilisateur ${user.name} n'est pas un employé et ne peut pas avoir de solde de congés.`, "error");
             return;
           }

           appData.leaveBalances[userId] = {
             annual: parseInt(row.annual_leave) || 0,
             exceptional: parseInt(row.exceptional_leave) || 0,
             recovery: parseInt(row.recovery_leave) || 0
           };
           
           // Ajouter à la file d'attente de synchronisation
           queueOperation({
             type: 'updateLeaveBalance',
             data: {
               userId: userId,
               balance: appData.leaveBalances[userId]
             }
           });
           
           updatedCount++;
         });

         if (updatedCount === 0) {
           showNotification("Aucun solde de congé n'a été mis à jour.", "error");
           return;
         }

         saveToLocalStorage();
         fileInput.value = '';
         updateLeaveBalanceDisplay();
         showNotification(`${updatedCount} solde(s) de congé mis à jour avec succès.`, "success");
       } catch (error) {
         console.error("Erreur lors de l'importation des soldes:", error);
         showNotification("Une erreur est survenue lors de l'importation des soldes de congés.", "error");
       }
     };
     reader.onerror = function() {
       showNotification("Erreur lors de la lecture du fichier des soldes.", "error");
     };
     reader.readAsArrayBuffer(file);
   });
 }

 // Configuration du bouton d'ajout d'utilisateur
 function setupAddUserBtn() {
   document.getElementById('add-user-btn').addEventListener('click', function() {
     showAddUserModal();
   });
 }

 // Affichage de la modal d'ajout d'utilisateur
 function showAddUserModal() {
   const modalContent = `
     <div class="space-y-4">
       <div>
         <label for="new-user-id" class="block text-sm font-medium text-gray-700 dark:text-gray-300">ID</label>
         <input type="number" id="new-user-id" class="mt-1 text-base block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white" placeholder="ID numérique">
       </div>
       <div>
         <label for="new-user-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Nom complet</label>
         <input type="text" id="new-user-name" class="mt-1 text-base block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white" placeholder="Prénom Nom">
       </div>
       <div>
         <label for="new-user-email" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Email</label>
         <input type="email" id="new-user-email" class="mt-1 text-base block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white" placeholder="email@example.com">
       </div>
       <div>
         <label for="new-user-role" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Rôle</label>
         <select id="new-user-role" class="mt-1 text-base block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white">
           <option value="Employé">Employé</option>
           <option value="Responsable">Responsable</option>
         </select>
       </div>
       <div>
         <label for="new-user-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Mot de passe</label>
         <input type="password" id="new-user-password" class="mt-1 text-base block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white" placeholder="••••••••">
       </div>
     </div>
   `;
   const modalActions = `
     <button id="confirm-add-user" class="inline-flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
       Ajouter l'utilisateur
     </button>
     <button class="modal-close inline-flex justify-center py-2 px-4 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
       Annuler
     </button>
   `;
   showModal(`Ajouter un nouvel utilisateur`, modalContent, modalActions);
   document.getElementById('confirm-add-user').addEventListener('click', addNewUser);
 }

 // Ajout d'un nouvel utilisateur
 async function addNewUser() {
   const idInput = document.getElementById('new-user-id');
   const nameInput = document.getElementById('new-user-name');
   const emailInput = document.getElementById('new-user-email');
   const roleInput = document.getElementById('new-user-role');
   const passwordInput = document.getElementById('new-user-password');

   const id = parseInt(idInput.value.trim());
   const name = nameInput.value.trim();
   const email = emailInput.value.trim();
   const role = roleInput.value;
   const password = passwordInput.value;

   // Validation des entrées
   if (!id || isNaN(id)) {
     showNotification("L'ID doit être un nombre valide.", "error");
     return;
   }
   if (!name) {
     showNotification("Le nom est requis.", "error");
     return;
   }
   if (!email || !email.includes('@')) {
     showNotification("L'email doit être valide.", "error");
     return;
   }
   if (!password) {
     showNotification("Le mot de passe est requis.", "error");
     return;
   }

   // Vérification si l'ID ou l'email existe déjà
   if (appData.users.some(u => u.id === id)) {
     showNotification(`Un utilisateur avec l'ID ${id} existe déjà.`, "error");
     return;
   }
   if (appData.users.some(u => u.email.toLowerCase() === email.toLowerCase())) {
     showNotification(`Un utilisateur avec l'email ${email} existe déjà.`, "error");
     return;
   }

   try {
     // Ajout du nouvel utilisateur
     const hashedPassword = await hashPassword(password);
     const newUser = { id, name, email, role, password: hashedPassword };
     appData.users.push(newUser);

     // Initialisation des soldes de congés si c'est un employé
     if (role === "Employé") {
       initializeLeaveBalances(id);
     }
     
     // Ajouter à la file d'attente de synchronisation
     queueOperation({
       type: 'addUser',
       data: newUser
     });

     await saveToLocalStorage();
     updateUsersTable();
     closeModal();
     showNotification(`L'utilisateur ${name} a été ajouté avec succès.`, "success");
   } catch (error) {
     console.error("Erreur lors de l'ajout de l'utilisateur:", error);
     showNotification("Une erreur est survenue lors de l'ajout de l'utilisateur.", "error");
   }
 }

 // Affichage de la modal d'édition d'utilisateur
 function showEditUserModal(userId) {
   const user = appData.users.find(u => u.id === userId);
   if (!user) return;

   const modalContent = `
     <div class="space-y-4">
       <div>
         <label for="edit-user-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Nom complet</label>
         <input type="text" id="edit-user-name" value="${user.name}" class="mt-1 text-base block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white" placeholder="Prénom Nom">
       </div>
       <div>
         <label for="edit-user-email" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Email</label>
         <input type="email" id="edit-user-email" value="${user.email}" class="mt-1 text-base block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white" placeholder="email@example.com">
       </div>
       <div>
         <label for="edit-user-role" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Rôle</label>
         <select id="edit-user-role" class="mt-1 text-base block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white">
           <option value="Employé" ${user.role === "Employé" ? "selected" : ""}>Employé</option>
           <option value="Responsable" ${user.role === "Responsable" ? "selected" : ""}>Responsable</option>
         </select>
       </div>
       <div>
         <label for="edit-user-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Nouveau mot de passe (laisser vide pour conserver l'actuel)</label>
         <input type="password" id="edit-user-password" class="mt-1 text-base block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white" placeholder="••••••••">
       </div>
     </div>
   `;
   const modalActions = `
     <button id="confirm-edit-user" data-user-id="${userId}" class="inline-flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
       Enregistrer les modifications
     </button>
     <button class="modal-close inline-flex justify-center py-2 px-4 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
       Annuler
     </button>
   `;
   showModal(`Modifier l'utilisateur ${user.name}`, modalContent, modalActions);
   document.getElementById('confirm-edit-user').addEventListener('click', function() {
     editUser(userId);
   });
 }

 // Édition d'un utilisateur
 async function editUser(userId) {
   const user = appData.users.find(u => u.id === userId);
   if (!user) return;

   const nameInput = document.getElementById('edit-user-name');
   const emailInput = document.getElementById('edit-user-email');
   const roleInput = document.getElementById('edit-user-role');
   const passwordInput = document.getElementById('edit-user-password');

   const newName = nameInput.value.trim();
   const newEmail = emailInput.value.trim();
   const newRole = roleInput.value;
   const newPassword = passwordInput.value;

   // Validation des entrées
   if (!newName) {
     showNotification("Le nom est requis.", "error");
     return;
   }
   if (!newEmail || !newEmail.includes('@')) {
     showNotification("L'email doit être valide.", "error");
     return;
   }

   // Vérification si l'email existe déjà (sauf pour cet utilisateur)
   if (appData.users.some(u => u.id !== userId && u.email.toLowerCase() === newEmail.toLowerCase())) {
     showNotification(`Un autre utilisateur avec l'email ${newEmail} existe déjà.`, "error");
     return;
   }

   try {
     // Mise à jour de l'utilisateur
     const oldRole = user.role;
     user.name = newName;
     user.email = newEmail;
     user.role = newRole;

     // Mise à jour du mot de passe si fourni
     if (newPassword) {
       user.password = await hashPassword(newPassword);
     }

     // Ajouter à la file d'attente de synchronisation
     queueOperation({
       type: 'updateUser',
       data: user
     });

     // Gérer les changements de rôle
     if (oldRole !== newRole) {
       if (newRole === "Employé") {
         // Si changement vers Employé, initialiser les soldes de congés
         initializeLeaveBalances(userId);
       }

       // Si l'utilisateur actuellement connecté est modifié
       if (appData.currentUser && appData.currentUser.id === userId) {
         appData.currentUser = user;
         document.querySelector('.user-role').textContent = newRole;
         // Rediriger vers la bonne vue en fonction du nouveau rôle
         showView(newRole === "Employé" ? 'employee-view' : 'manager-view');
       }
     }

     await saveToLocalStorage();
     updateUsersTable();
     closeModal();
     showNotification(`L'utilisateur ${newName} a été modifié avec succès.`, "success");
   } catch (error) {
     console.error("Erreur lors de la modification de l'utilisateur:", error);
     showNotification("Une erreur est survenue lors de la modification de l'utilisateur.", "error");
   }
 }

 // Affichage de la modal de suppression d'utilisateur
 function showDeleteUserModal(userId) {
   const user = appData.users.find(u => u.id === userId);
   if (!user) return;

   // Empêcher la suppression de l'utilisateur actuellement connecté
   if (appData.currentUser && appData.currentUser.id === userId) {
     showNotification("Vous ne pouvez pas supprimer votre propre compte pendant que vous êtes connecté.", "error");
     return;
   }

   const modalContent = `
     <p class="text-gray-700 dark:text-gray-300">
       Êtes-vous sûr de vouloir supprimer l'utilisateur <strong>${user.name}</strong> ?<br>
       Cette action est irréversible et supprimera également toutes les demandes associées.
     </p>
   `;
   const modalActions = `
     <button id="confirm-delete-user" data-user-id="${userId}" class="inline-flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
       Supprimer définitivement
     </button>
     <button class="modal-close inline-flex justify-center py-2 px-4 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
       Annuler
     </button>
   `;
   showModal(`Supprimer l'utilisateur`, modalContent, modalActions);
   
   // Ajouter un effet shake au bouton de confirmation pour avertir l'utilisateur
   const confirmButton = document.getElementById('confirm-delete-user');
   confirmButton.classList.add('confirm-btn-shake');
   
   confirmButton.addEventListener('click', function() {
     deleteUser(userId);
   });
 }

 // Suppression d'un utilisateur
 async function deleteUser(userId) {
   // Supprimer l'utilisateur
   appData.users = appData.users.filter(u => u.id !== userId);
   
   // Supprimer ses demandes
   const userRequests = appData.requests.filter(req => req.employeeId === userId);
   appData.requests = appData.requests.filter(req => req.employeeId !== userId);
   
   // Supprimer ses soldes de congés
   if (appData.leaveBalances[userId]) {
     delete appData.leaveBalances[userId];
   }
   
   // Ajouter toutes les opérations de suppression à la file d'attente
   queueOperation({
     type: 'deleteUser',
     data: { id: userId }
   });
   
   // Supprimer chaque demande de l'utilisateur
   for (const req of userRequests) {
     queueOperation({
       type: 'deleteRequest',
       data: { id: req.id }
     });
   }
   
   // Supprimer les soldes de congés
   queueOperation({
     type: 'deleteLeaveBalance',
     data: { userId: userId }
   });
   
   await saveToLocalStorage();
   updateUsersTable();
   updateManagerRequestsTables();
   closeModal();
   showNotification("L'utilisateur a été supprimé avec succès.", "success");
 }

 // Configuration du bouton de réinitialisation des données
 function setupResetDataBtn() {
   document.getElementById('reset-data-btn').addEventListener('click', function() {
     showResetConfirmationModal();
   });
 }

 // Affichage de la modal de confirmation de réinitialisation
 function showResetConfirmationModal() {
   const modalContent = `
     <p class="text-gray-700 dark:text-gray-300">
       <i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>
       <strong>Attention :</strong> Vous êtes sur le point de réinitialiser toutes les données de l'application.<br><br>
       Cette action supprimera :
       <ul class="list-disc list-inside mt-2 ml-2 space-y-1">
         <li>Tous les utilisateurs (sauf les utilisateurs par défaut)</li>
         <li>Toutes les demandes (congés, autorisations, avances)</li>
         <li>Tous les soldes de congés personnalisés</li>
       </ul>
       <br>
       Cette action est irréversible. Voulez-vous continuer ?
     </p>
   `;
   const modalActions = `
     <button id="confirm-reset" class="inline-flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
       Réinitialiser toutes les données
     </button>
     <button class="modal-close inline-flex justify-center py-2 px-4 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
       Annuler
     </button>
   `;
   showModal(`Réinitialisation des données`, modalContent, modalActions);
   
   // Ajouter un effet shake au bouton de confirmation
   const confirmButton = document.getElementById('confirm-reset');
   confirmButton.classList.add('confirm-btn-shake');
   
   confirmButton.addEventListener('click', function() {
     resetToDefaultData();
     closeModal();
   });
 }

 // Réinitialisation des données par défaut
 async function resetToDefaultData() {
   try {
     showLoading("Réinitialisation des données", "Veuillez patienter pendant que les données sont réinitialisées...");
     
     // Récupérer les IDs des données à supprimer
     const usersToDelete = appData.users.filter(user => user.id !== 76 && user.id !== 1);
     const requestsToDelete = [...appData.requests];
     const balancesToDelete = {...appData.leaveBalances};
     
     // Créer les utilisateurs par défaut
     const defaultUsers = [
       { id: 76, name: "ALILI HOUSSEM", email: "alilihoussem@easywayelecto.com", role: "Responsable", password: await hashPassword("1234") },
       { id: 1, name: "John Doe", email: "john.doe@example.com", role: "Employé", password: await hashPassword("1234") }
     ];
     
     appData.users = defaultUsers;
     appData.requests = [];
     appData.leaveBalances = {};
     
     // Initialisation des soldes de congés pour les utilisateurs par défaut
     defaultUsers.forEach(user => {
       if (user.role === "Employé") {
         initializeLeaveBalances(user.id);
       }
     });
     
     // Ajouter les opérations de suppression à la file d'attente
     for (const user of usersToDelete) {
       queueOperation({
         type: 'deleteUser',
         data: { id: user.id }
       });
     }
     
     for (const request of requestsToDelete) {
       queueOperation({
         type: 'deleteRequest',
         data: { id: request.id }
       });
     }
     
     for (const userId in balancesToDelete) {
       if (userId !== '1') { // Ne pas supprimer les soldes de l'utilisateur par défaut
         queueOperation({
           type: 'deleteLeaveBalance',
           data: { userId: parseInt(userId) }
         });
       }
     }
     
     // Ajouter ou mettre à jour les utilisateurs par défaut
     for (const user of defaultUsers) {
       queueOperation({
         type: 'updateUser',
         data: user
       });
     }
     
     // Mettre à jour les soldes de l'utilisateur par défaut
     queueOperation({
       type: 'updateLeaveBalance',
       data: {
         userId: 1,
         balance: appData.leaveBalances[1]
       }
     });
     
     await saveToLocalStorage();
     
     // Synchroniser si en ligne
     if (appData.isOnline) {
       await processPendingOperations();
     }
     
     // Mettre à jour l'interface si l'utilisateur est connecté
     if (appData.currentUser) {
       const userStillExists = appData.users.find(u => u.id === appData.currentUser.id);
       if (userStillExists) {
         appData.currentUser = userStillExists;
         if (appData.currentUser.role === "Employé") {
           updateLeaveBalanceDisplay();
           updateEmployeeRequestsTable();
         } else if (appData.currentUser.role === "Responsable") {
           updateManagerRequestsTables();
           updateUsersTable();
         }
       } else {
         // L'utilisateur n'existe plus après réinitialisation
         await logout();
       }
     }
     
     hideLoading();
     showNotification("Les données ont été réinitialisées avec succès.", "success");
   } catch (error) {
     console.error("Erreur lors de la réinitialisation des données:", error);
     hideLoading();
     showNotification("Une erreur est survenue lors de la réinitialisation des données.", "error");
   }
 }

 // Configuration du bouton d'exportation des données
 function setupExportDataBtn() {
   document.getElementById('export-data-btn').addEventListener('click', function() {
     exportToExcel();
   });
 }

 // Configuration du bouton de synchronisation
 function setupSyncDataBtn() {
   document.getElementById('sync-data-btn').addEventListener('click', function() {
     syncAllDataWithFirebase(true);
   });
 }

 // Exportation des données vers Excel
 function exportToExcel() {
   try {
     // Créer un nouveau classeur
     const wb = XLSX.utils.book_new();
     
     // Feuille des utilisateurs
     const usersData = appData.users.map(user => ({
       ID: user.id,
       Nom: user.name,
       Email: user.email,
       Rôle: user.role
     }));
     const usersSheet = XLSX.utils.json_to_sheet(usersData);
     XLSX.utils.book_append_sheet(wb, usersSheet, "Utilisateurs");
     
     // Feuille des soldes de congés
     const leaveBalancesData = [];
     for (const userId in appData.leaveBalances) {
       const user = getUserById(parseInt(userId));
       if (user && user.name !== "Employé inconnu") {
         leaveBalancesData.push({
           ID: parseInt(userId),
           Nom: user.name,
           Email: user.email,
           "Congés Annuels": appData.leaveBalances[userId].annual,
           "Congés Exceptionnels": appData.leaveBalances[userId].exceptional,
           "Congés Récupération": appData.leaveBalances[userId].recovery
         });
       }
     }
     if (leaveBalancesData.length > 0) {
       const leaveBalancesSheet = XLSX.utils.json_to_sheet(leaveBalancesData);
       XLSX.utils.book_append_sheet(wb, leaveBalancesSheet, "Soldes de congés");
     }
     
     // Feuille des demandes
     const requestsData = appData.requests.map(req => {
       const employee = getUserById(req.employeeId);
       return {
         ID: req.id,
         "Employé": employee.name,
         "Email Employé": employee.email,
         Type: req.type,
         Date: req.date,
         Détails: req.details,
         Statut: req.status,
         "Créé le": new Date(req.createdAt).toLocaleString(),
         Commentaire: req.comment
       };
     });
     if (requestsData.length > 0) {
       const requestsSheet = XLSX.utils.json_to_sheet(requestsData);
       XLSX.utils.book_append_sheet(wb, requestsSheet, "Demandes");
     }
     
     // Générer le fichier Excel
     const now = new Date();
     const dateStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
     const fileName = `export-gestion-conges-${dateStr}.xlsx`;
     
     XLSX.writeFile(wb, fileName);
     showNotification("Les données ont été exportées avec succès.", "success");
   } catch (error) {
     console.error("Erreur lors de l'exportation des données:", error);
     showNotification("Une erreur est survenue lors de l'exportation des données. Vérifiez les instructions du fabricant pour télécharger l'Excel manuellement.", "error");
     
     // Message alternatif sur la façon dont un utilisateur peut exporter manuellement les données
     showModal("Exportation des données", `
       <p class="text-gray-700 dark:text-gray-300">
         L'exportation automatique a échoué. Vous pouvez exporter manuellement les données en suivant ces étapes :
         <ol class="list-decimal list-inside mt-2 ml-2 space-y-1">
           <li>Ouvrez la console développeur (F12 ou Ctrl+Shift+I)</li>
           <li>Copiez et collez la commande suivante :</li>
         </ol>
         <div class="mt-2 bg-gray-100 dark:bg-gray-700 p-2 rounded">
           <code>console.log(JSON.stringify({users: appData.users, requests: appData.requests, leaveBalances: appData.leaveBalances}))</code>
         </div>
         <p class="mt-2">Puis sauvegardez la sortie dans un fichier texte.</p>
       </p>
     `, `<button class="modal-close inline-flex justify-center py-2 px-4 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">Fermer</button>`);
   }
 }

 // Initialisation de l'application
 async function initApp() {
   try {
     // Afficher l'écran de chargement initial
     showLoading("Initialisation de l'application", "Chargement des données...");
     
     // Initialiser le stockage local
     await localDB.initializeStorage();
     
     // Configurer les écouteurs d'état de connexion réseau
     setupNetworkListeners();
     
     // Chargement des données locales en premier pour l'affichage rapide
     await loadFromLocalStorage();
     
     // Mise en place des différents gestionnaires d'événements
     setupLoginForm();
     setupLeaveForm();
     setupLeaveRequestForm();
     setupAdvanceRequestForm();
     setupExcelImport();
     setupLeaveBalanceImport();
     setupAddUserBtn();
     setupResetDataBtn();
     setupExportDataBtn();
     setupSyncDataBtn();
     
     // Initialisation des champs de date avec la date du jour
     initDateFields();
     
     // Si un utilisateur était déjà connecté, reconnecter automatiquement
     const savedUser = await localDB.getCurrentUser();
     if (savedUser) {
       appData.currentUser = savedUser;
       document.querySelector('.user-name').textContent = savedUser.name;
       document.querySelector('.user-role').textContent = savedUser.role;
       document.getElementById('logout-button').classList.remove('hidden');
       showView(savedUser.role === "Employé" ? 'employee-view' : 'manager-view');
     } else {
       // Affichage de la vue de connexion
       showView('login-view');
     }
     
     // Masquer l'écran de chargement
     hideLoading();
     
     // Mise en place de la synchronisation périodique
     setupPeriodicSync();
     
     // Tenter de récupérer les données depuis Firebase en arrière-plan
     if (appData.isOnline) {
       fetchAllDataFromFirebase().catch(error => {
         console.log("Mode hors ligne activé", error);
       });
     } else {
       updateSyncStatus('offline', "Hors ligne");
     }
     
     console.log("Application initialisée avec succès");
   } catch (error) {
     console.error("Erreur lors de l'initialisation de l'application:", error);
     hideLoading();
     showNotification("Une erreur est survenue lors de l'initialisation de l'application.", "error");
     
     // Fallback vers le mode local uniquement avec les données déjà chargées
     updateSyncStatus('offline', "Erreur d'initialisation");
     showView('login-view');
   }
 }

 // Initialisation des champs de date
 function initDateFields() {
   const today = new Date().toISOString().split('T')[0];
   document.getElementById('leave-date').setAttribute('min', today);
   document.getElementById('leave-date').value = today;
   document.getElementById('advance-date').setAttribute('min', today);
   document.getElementById('advance-date').value = today;
   document.getElementById('leave-start-date').setAttribute('min', today);
   document.getElementById('leave-end-date').setAttribute('min', today);
 }

 // Démarrage de l'application lorsque le DOM est chargé
 document.addEventListener('DOMContentLoaded', initApp);
</script>
